<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTG Dashboard</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Financial dashboard for FTG Builders">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FTG Dashboard">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- Google Fonts - Optimized loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css?v=20251225ab" />

  <!-- PERFORMANCE: Export libraries (EmailJS, html2canvas, jsPDF, XLSX, ExcelJS) are now lazy-loaded in dashboard.js when needed -->
</head>

<body>
  <!-- Admin nav visibility fix - handles cached credentials on page load -->
  <script>
    (function() {
      var cached = localStorage.getItem('ftg_is_admin');
      var auth = localStorage.getItem('ftg_authenticated');
      var token = localStorage.getItem('ftg_session_token');
      
      // If authenticated but admin cache is missing, fetch it from API
      if (auth === 'true' && token && cached === null) {
        fetch('/api/verify-session', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success && data.user) {
            var role = data.user.role || '';
            var isAdmin = role.toLowerCase() === 'admin';
            localStorage.setItem('ftg_is_admin', isAdmin ? 'true' : 'false');
            localStorage.setItem('ftg_user_role', role);
            if (isAdmin) {
              var adminNav = document.getElementById('adminNavItem');
              if (adminNav) adminNav.classList.remove('hidden');
            }
          }
        })
        .catch(function(e) { console.log('Admin check failed:', e); });
      }
      
      // If cached as admin, show nav immediately when DOM is ready
      if (cached === 'true' && auth === 'true') {
        var checkNav = setInterval(function() {
          var adminNav = document.getElementById('adminNavItem');
          if (adminNav) {
            adminNav.classList.remove('hidden');
            clearInterval(checkNav);
          }
        }, 50);
        setTimeout(function() { clearInterval(checkNav); }, 3000);
      }
    })();
  </script>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <img src="logo.png" alt="FTG Logo" class="login-logo">
      <h2>FTG Dashboard</h2>
      <p>Please enter your email and password</p>
      <form id="loginForm" onsubmit="return doLogin(event)">
        <input type="email" id="loginUsername" placeholder="Email address" autocomplete="username">
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
        <button type="submit" id="loginBtn">Login</button>
      </form>
      
      <!-- 2FA Verification Form (hidden by default) -->
      <form id="twoFAForm" class="hidden" onsubmit="return verify2FA(event)">
        <p style="color:#6b7280;font-size:14px;margin-bottom:12px;">Enter the 6-digit code from your authenticator app</p>
        <input type="text" id="twoFACode" placeholder="000000" maxlength="8" autocomplete="one-time-code" style="text-align:center;font-size:24px;letter-spacing:8px;">
        <button type="submit" id="verify2FABtn">Verify</button>
        <a href="#" id="cancel2FALink" style="display:block;margin-top:10px;font-size:12px;color:#6b7280;">Cancel and go back</a>
      </form>
      
      <!-- Forgot Password Form (hidden by default) -->
      <form id="forgotPasswordForm" class="hidden" onsubmit="return requestPasswordReset(event)">
        <p style="color:#6b7280;font-size:14px;margin-bottom:12px;">Enter your email to receive a password reset link</p>
        <input type="email" id="resetEmail" placeholder="Email address" autocomplete="username">
        <button type="submit" id="resetPasswordBtn">Send Reset Link</button>
        <a href="#" id="cancelResetLink" style="display:block;margin-top:10px;font-size:12px;color:#6b7280;">Back to login</a>
      </form>
      
      <!-- Complete Password Reset Form (hidden by default) -->
      <form id="completeResetForm" class="hidden" onsubmit="return completePasswordReset(event)">
        <p style="color:#6b7280;font-size:14px;margin-bottom:12px;">Enter your new password</p>
        <input type="password" id="newResetPassword" placeholder="New password" autocomplete="new-password">
        <input type="password" id="confirmResetPassword" placeholder="Confirm password" autocomplete="new-password">
        <button type="submit" id="completeResetBtn">Set New Password</button>
      </form>
      
      <p id="loginError" class="login-error"></p>
      <p id="loginSuccess" class="login-success hidden" style="color:#10b981;font-size:14px;margin-top:10px;"></p>
      <a href="#" id="forgotPasswordLink" style="font-size:12px;color:#6b7280;text-decoration:underline;cursor:pointer;">Forgot password?</a>
    </div>
  </div>
  <script>
    var pending2FAToken = null;
    var pending2FAEmail = null;
    
    async function doLogin(event) {
      if (event) event.preventDefault();
      var email = document.getElementById('loginUsername').value.toLowerCase().trim();
      var pwd = document.getElementById('loginPassword').value;
      var err = document.getElementById('loginError');
      var btn = document.getElementById('loginBtn');
      
      if (!email) {
        err.textContent = 'Please enter your email address.';
        return false;
      }
      
      if (!pwd) {
        err.textContent = 'Please enter your password.';
        return false;
      }
      
      btn.disabled = true;
      btn.textContent = 'Logging in...';
      err.textContent = '';
      
      try {
        var response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email, password: pwd })
        });
        
        var data = await response.json();
        
        if (data.success) {
          if (data.requires_2fa) {
            // Show 2FA form
            pending2FAToken = data.twofa_token;
            pending2FAEmail = data.email;
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('twoFAForm').classList.remove('hidden');
            document.getElementById('forgotPasswordLink').classList.add('hidden');
            document.getElementById('twoFACode').focus();
            btn.disabled = false;
            btn.textContent = 'Login';
            return false;
          }
          
          completeLogin(data);
        } else {
          err.textContent = data.error || 'Login failed. Please try again.';
        }
      } catch (e) {
        console.error('Login error:', e);
        err.textContent = 'Connection error. Please try again.';
      }
      
      btn.disabled = false;
      btn.textContent = 'Login';
      return false;
    }
    
    function completeLogin(data) {
      localStorage.setItem('ftg_authenticated', 'true');
      localStorage.setItem('ftg_current_user', data.email);
      localStorage.setItem('ftg_session_token', data.token);
      
      // Cache role and admin status for immediate access on page refresh
      var role = data.role || '';
      var isAdmin = role.toLowerCase() === 'admin';
      localStorage.setItem('ftg_user_role', role);
      localStorage.setItem('ftg_is_admin', isAdmin ? 'true' : 'false');
      
      document.getElementById('loginScreen').classList.add('hidden');
      
      var userLabel = document.getElementById('currentUser');
      if (userLabel) userLabel.textContent = data.displayName;
      
      // Show admin nav immediately if user is admin
      if (isAdmin) {
        var adminNavItem = document.getElementById('adminNavItem');
        if (adminNavItem) adminNavItem.classList.remove('hidden');
        window.isAdminUser = true;
      }
      window.userRole = role;
      
      if (typeof loadUserPreferences === 'function') {
        setTimeout(function() { loadUserPreferences(); }, 100);
      }
      if (typeof checkAdminAccess === 'function') {
        setTimeout(function() { checkAdminAccess(); }, 100);
      }
    }
    
    async function verify2FA(event) {
      if (event) event.preventDefault();
      var code = document.getElementById('twoFACode').value.trim();
      var err = document.getElementById('loginError');
      var btn = document.getElementById('verify2FABtn');
      
      if (!code) {
        err.textContent = 'Please enter the verification code.';
        return false;
      }
      
      btn.disabled = true;
      btn.textContent = 'Verifying...';
      err.textContent = '';
      
      try {
        var response = await fetch('/api/login/2fa', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ twofa_token: pending2FAToken, code: code })
        });
        
        var data = await response.json();
        
        if (data.success) {
          completeLogin(data);
        } else {
          err.textContent = data.error || 'Verification failed. Please try again.';
        }
      } catch (e) {
        console.error('2FA verification error:', e);
        err.textContent = 'Connection error. Please try again.';
      }
      
      btn.disabled = false;
      btn.textContent = 'Verify';
      return false;
    }
    
    async function requestPasswordReset(event) {
      if (event) event.preventDefault();
      var email = document.getElementById('resetEmail').value.toLowerCase().trim();
      var err = document.getElementById('loginError');
      var success = document.getElementById('loginSuccess');
      var btn = document.getElementById('resetPasswordBtn');
      
      if (!email) {
        err.textContent = 'Please enter your email address.';
        return false;
      }
      
      btn.disabled = true;
      btn.textContent = 'Sending...';
      err.textContent = '';
      success.textContent = '';
      success.classList.add('hidden');
      
      try {
        var response = await fetch('/api/request-password-reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email })
        });
        
        var data = await response.json();
        
        if (data.success) {
          success.textContent = data.message;
          success.classList.remove('hidden');
          setTimeout(function() {
            showLoginForm();
          }, 5000);
        } else {
          err.textContent = data.error || 'Request failed. Please try again.';
        }
      } catch (e) {
        console.error('Password reset request error:', e);
        err.textContent = 'Connection error. Please try again.';
      }
      
      btn.disabled = false;
      btn.textContent = 'Send Reset Link';
      return false;
    }
    
    async function completePasswordReset(event) {
      if (event) event.preventDefault();
      var newPass = document.getElementById('newResetPassword').value;
      var confirmPass = document.getElementById('confirmResetPassword').value;
      var err = document.getElementById('loginError');
      var success = document.getElementById('loginSuccess');
      var btn = document.getElementById('completeResetBtn');
      
      if (!newPass || newPass.length < 6) {
        err.textContent = 'Password must be at least 6 characters.';
        return false;
      }
      
      if (newPass !== confirmPass) {
        err.textContent = 'Passwords do not match.';
        return false;
      }
      
      btn.disabled = true;
      btn.textContent = 'Saving...';
      err.textContent = '';
      
      try {
        var urlParams = new URLSearchParams(window.location.search);
        var resetToken = urlParams.get('reset_token');
        
        var response = await fetch('/api/complete-password-reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reset_token: resetToken, new_password: newPass })
        });
        
        var data = await response.json();
        
        if (data.success) {
          success.textContent = data.message;
          success.classList.remove('hidden');
          window.history.replaceState({}, document.title, window.location.pathname);
          setTimeout(function() {
            showLoginForm();
          }, 3000);
        } else {
          err.textContent = data.error || 'Password reset failed. Please try again.';
        }
      } catch (e) {
        console.error('Password reset completion error:', e);
        err.textContent = 'Connection error. Please try again.';
      }
      
      btn.disabled = false;
      btn.textContent = 'Set New Password';
      return false;
    }
    
    function showLoginForm() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('twoFAForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.add('hidden');
      document.getElementById('completeResetForm').classList.add('hidden');
      document.getElementById('forgotPasswordLink').classList.remove('hidden');
      document.getElementById('loginError').textContent = '';
      document.getElementById('loginSuccess').textContent = '';
      document.getElementById('loginSuccess').classList.add('hidden');
      pending2FAToken = null;
      pending2FAEmail = null;
    }
    
    function showForgotPasswordForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('twoFAForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.remove('hidden');
      document.getElementById('completeResetForm').classList.add('hidden');
      document.getElementById('forgotPasswordLink').classList.add('hidden');
      document.getElementById('loginError').textContent = '';
      document.getElementById('loginSuccess').textContent = '';
      document.getElementById('loginSuccess').classList.add('hidden');
      document.getElementById('resetEmail').focus();
    }
    
    function checkForResetToken() {
      var urlParams = new URLSearchParams(window.location.search);
      var resetToken = urlParams.get('reset_token');
      if (resetToken) {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('completeResetForm').classList.remove('hidden');
        document.getElementById('forgotPasswordLink').classList.add('hidden');
        document.getElementById('newResetPassword').focus();
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      var forgotLink = document.getElementById('forgotPasswordLink');
      if (forgotLink) {
        forgotLink.onclick = function(e) {
          e.preventDefault();
          showForgotPasswordForm();
        };
      }
      
      var cancelResetLink = document.getElementById('cancelResetLink');
      if (cancelResetLink) {
        cancelResetLink.onclick = function(e) {
          e.preventDefault();
          showLoginForm();
        };
      }
      
      var cancel2FALink = document.getElementById('cancel2FALink');
      if (cancel2FALink) {
        cancel2FALink.onclick = function(e) {
          e.preventDefault();
          showLoginForm();
        };
      }
      
      checkForResetToken();
    });
    
    async function checkExistingSession() {
      var token = localStorage.getItem('ftg_session_token');
      if (!token) return;
      
      try {
        var response = await fetch('/api/verify-session', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        var data = await response.json();
        
        if (data.success && data.user) {
          document.getElementById('loginScreen').classList.add('hidden');
          var userLabel = document.getElementById('currentUser');
          if (userLabel) userLabel.textContent = data.user.displayName;
          
          // Check admin access after restoring session
          if (typeof checkAdminAccess === 'function') {
            setTimeout(function() { checkAdminAccess(); }, 500);
          }
        } else {
          localStorage.removeItem('ftg_session_token');
          localStorage.removeItem('ftg_authenticated');
        }
      } catch (e) {
        console.error('Session check error:', e);
      }
    }
    
    if (localStorage.getItem('ftg_session_token')) {
      checkExistingSession();
    }
    
    document.getElementById('forgotPasswordLink').onclick = function(e) {
      e.preventDefault();
      var email = document.getElementById('loginUsername').value.toLowerCase().trim();
      var err = document.getElementById('loginError');
      
      if (!email) {
        err.textContent = 'Please enter your email address first.';
        return;
      }
      
      var resetCode = prompt('Enter admin reset code to reset password to default:');
      if (resetCode === 'FTG2025Reset') {
        err.style.color = '#166534';
        err.textContent = 'Please contact your administrator to reset your password.';
      } else if (resetCode) {
        err.textContent = 'Invalid reset code. Contact administrator.';
      }
    };
  </script>

  <!-- HEADER -->
  <header class="header">
    <button id="mobileMenuButton" class="mobile-menu-btn">‚ò∞</button>

    <div class="header-left">
      <!-- YOUR LOGO HERE -->
      <img src="logo.png" alt="FTG Logo" class="header-logo">
      <h1 class="logo">FTG Dashboard</h1>
    </div>

    <div class="header-right">
      <!-- Dark Mode Toggle -->
      <button id="darkModeToggle" class="dark-mode-toggle" title="Toggle dark mode">
        <span class="dark-mode-icon-light">‚òÄÔ∏è</span>
        <span class="dark-mode-icon-dark">üåô</span>
      </button>
      
      <!-- User Menu Dropdown -->
      <div class="user-dropdown">
        <button id="userDropdownBtn" class="user-dropdown-btn">
          <span id="currentUser" class="user-label"></span>
          <span class="user-dropdown-arrow">‚ñº</span>
        </button>
        <div id="userDropdownMenu" class="dropdown-menu hidden">
          <div class="dropdown-item theme-selector">
            <span>üé® Theme</span>
            <select id="themeSelect" onclick="event.stopPropagation()">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div id="myPmViewToggleContainer" class="dropdown-item pm-view-toggle hidden" onclick="event.stopPropagation()">
            <span>üë§ My PM View</span>
            <label class="toggle-switch small">
              <input type="checkbox" id="myPmViewToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <button id="changePasswordBtn" class="dropdown-item">üîë Change Password</button>
          <button id="securitySettingsBtn" class="dropdown-item">üîê Security Settings</button>
          <button id="logoutBtn" class="dropdown-item">üö™ Logout</button>
        </div>
      </div>
    </div>
  </header>

  <div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="logo.png" alt="FTG Logo">
        <span>FTG Dashboard</span>
      </div>
      
      <!-- Sidebar Collapse Toggle (Desktop) -->
      <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" title="Collapse sidebar">
        <span class="collapse-icon">‚óÄ</span>
      </button>
      
      <nav>
        <ul>
          <!-- Financials Section -->
          <li class="nav-section">
            <div class="nav-section-header" id="navFinancialStatements">
              <span class="nav-section-icon">üìä</span>
              <span class="nav-section-label">Financials</span>
              <span class="nav-section-toggle">‚ñº</span>
            </div>
            <ul class="nav-section-items" id="navFinancialStatementsChildren">
              <li class="nav-item nav-child" data-section="overview">Overview</li>
              <li class="nav-item nav-child" data-section="aiInsights">AI Insights</li>
              <li class="nav-item nav-child" data-section="incomeStatement">Income Statement</li>
              <li class="nav-item nav-child" data-section="balanceSheet">Balance Sheet</li>
              <li class="nav-item nav-child" data-section="cashFlows">Statement of Cash Flows</li>
              <li class="nav-item nav-child" data-section="cashReports">Cash Balances</li>
              <li class="nav-item nav-child" data-section="accounts">Account Detail</li>
              <li class="nav-item nav-child" data-section="payments">Payments</li>
              <li class="nav-item nav-child" data-section="apAging">AP Aging</li>
              <li class="nav-item nav-child" data-section="arAging">AR Aging</li>
            </ul>
          </li>
          
          <!-- Jobs Section -->
          <li class="nav-section">
            <div class="nav-section-header" id="navJobs">
              <span class="nav-section-icon">üìÅ</span>
              <span class="nav-section-label">Jobs</span>
              <span class="nav-section-toggle">‚ñº</span>
            </div>
            <ul class="nav-section-items" id="navJobsChildren">
              <li class="nav-item nav-child" data-section="jobOverview">Overview</li>
              <li class="nav-item nav-child" data-section="jobBudgets">Budgets</li>
              <li class="nav-item nav-child" data-section="jobActuals">Actuals</li>
              <li class="nav-item nav-child" data-section="overUnderBilling">Over/(Under) Billing</li>
              <li class="nav-item nav-child" data-section="costCodes">Cost Codes</li>
            </ul>
          </li>
          
          <!-- Distribution Reports Section (Admin Only) -->
          <li class="nav-section hidden" id="distReportsSection">
            <div class="nav-section-header" id="navDistReports">
              <span class="nav-section-icon">üìã</span>
              <span class="nav-section-label">Distribution Reports</span>
              <span class="nav-section-toggle">‚ñº</span>
            </div>
            <ul class="nav-section-items" id="navDistReportsChildren">
              <li class="nav-item nav-child" data-section="deptHeadMeeting">Dept Head Meeting</li>
              <li class="nav-item nav-child" data-section="cashReport">Cash Report</li>
              <li class="nav-item nav-child" data-section="monthEndReporting">Month End Reporting</li>
            </ul>
          </li>
          
          <!-- Admin Section (standalone) -->
          <li class="nav-item admin-nav-item hidden" data-section="admin" id="adminNavItem">
            <span class="nav-item-icon">‚öôÔ∏è</span>
            <span class="nav-item-label">Admin</span>
          </li>
        </ul>
      </nav>
    </aside>

    <div id="overlay" class="overlay hidden"></div>

    <!-- MAIN CONTENT -->
    <main class="content">
      <!-- Export Ribbon (Desktop) / Dropdown (Mobile) -->
      <div class="content-export-area">
        <!-- Desktop Ribbon -->
        <div class="export-ribbon">
          <button id="exportPrintBtnRibbon" class="ribbon-btn" title="Print">
            <span class="ribbon-icon">üñ®Ô∏è</span>
            <span class="ribbon-label">Print</span>
          </button>
          <button id="exportPdfBtnRibbon" class="ribbon-btn" title="PDF">
            <span class="ribbon-icon">üìÑ</span>
            <span class="ribbon-label">PDF</span>
          </button>
          <button id="exportEmailBtnRibbon" class="ribbon-btn" title="Email">
            <span class="ribbon-icon">üìß</span>
            <span class="ribbon-label">Email</span>
          </button>
          <button id="scheduleEmailBtnRibbon" class="ribbon-btn" title="Schedule">
            <span class="ribbon-icon">üìÖ</span>
            <span class="ribbon-label">Schedule</span>
          </button>
        </div>
        <!-- Mobile Dropdown -->
        <div class="export-dropdown mobile-only">
          <button id="exportDropdownBtn" class="export-dropdown-btn" title="Export options">‚¨áÔ∏è</button>
          <div id="exportDropdownMenu" class="dropdown-menu hidden">
            <button id="exportPrintBtn" class="dropdown-item">üñ®Ô∏è Print</button>
            <button id="exportPdfBtn" class="dropdown-item">üìÑ PDF</button>
            <button id="exportEmailBtn" class="dropdown-item">üìß Email</button>
            <button id="scheduleEmailBtn" class="dropdown-item">üìÖ Schedule Email</button>
          </div>
        </div>
      </div>

      <!-- OVERVIEW SECTION -->
      <section id="overview" class="dashboard-section">
        <div id="greetingSection" class="greeting-section">
          <div class="greeting-text" id="greetingText">Good morning</div>
          <div class="greeting-date" id="greetingDate"></div>
        </div>
        <h2>Financial Overview</h2>
        <div class="data-as-of">Data as of: <span id="overviewDataAsOf"></span></div>

        <div class="config-panel">
          <div class="config-header" data-target="overviewConfigBody">
            <span class="config-toggle">‚ñº</span>
            <span class="config-title">Configuration Options</span>
            <button class="config-expand-btn">Collapse ‚ñ≤</button>
          </div>
          <div class="config-body" id="overviewConfigBody">
            <div class="overview-config-row overview-time-visuals-row">
              <div class="overview-config-box overview-time-period-box">
                <div class="time-period-group">
                  <div style="font-weight: 600; margin-bottom: 8px;">Time Period:</div>
                  <div class="time-period-buttons">
                    <button type="button" class="time-period-btn" data-view="monthly">Monthly</button>
                    <button type="button" class="time-period-btn active" data-view="quarterly">Quarterly</button>
                    <button type="button" class="time-period-btn" data-view="annual">Annual</button>
                  </div>
                  <input type="hidden" id="overviewViewType" value="quarterly">
                </div>
                <div class="overview-year-select-wrapper" id="overviewYearSelectWrapper">
                  <label>Year:</label>
                  <select id="overviewYear"></select>
                </div>
                <div class="year-slider-section year-range-inline" id="overviewYearSliderSection" style="display: none;">
                  <label>Year Range:</label>
                  <span id="overviewRangeStartLabel" class="year-label">2018</span>
                  <input type="range" id="overviewRangeStart" min="2015" max="2025" value="2018" step="1" class="year-slider">
                  <span class="range-separator">to</span>
                  <input type="range" id="overviewRangeEnd" min="2015" max="2025" value="2025" step="1" class="year-slider">
                  <span id="overviewRangeEndLabel" class="year-label">2025</span>
                </div>
              </div>

              <div class="overview-config-box overview-visuals-box">
                <label class="section-label" style="font-weight: 600;">Visuals:</label>
                <div class="visuals-checkboxes">
                  <label class="checkbox-label" id="overviewCompareLabel">
                    <input type="checkbox" id="overviewCompare">
                    Compare to Prior Year
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="overviewTrend" checked>
                    Show Trendline
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="overviewDataLabels">
                    Show Data Labels
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="overviewExclude" checked>
                    Exclude Month in Progress
                  </label>
                </div>
              </div>

              <div class="overview-config-box overview-metrics-box">
                <label class="section-label" style="font-weight: 600;">Show Metrics:</label>
                <div class="metric-checkboxes">
                  <label class="checkbox-label">
                    <input type="checkbox" id="showRevenue" checked data-metric="revenue">
                    Revenue
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="showGrossMargin" checked data-metric="grossMargin">
                    Gross Profit %
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="showOpMargin" checked data-metric="opMargin">
                    Operating Profit %
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="showCash" checked data-metric="cash">
                    Cash
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="showArApRatio" checked data-metric="arApRatio">
                    AR/AP Ratio
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="showOverUnder" checked data-metric="overUnder">
                    Over/Under Billing
                  </label>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div id="overviewAiAnalysisPanel" class="ai-analysis-panel">
          <div class="ai-analysis-header" id="overviewAiAnalysisHeader">
            <div class="ai-analysis-header-left">
              <span class="ai-analysis-toggle-icon">‚ñº</span>
              <span class="ai-analysis-title">AI ANALYSIS</span>
              <button type="button" id="overviewAiAnalyzeBtn" class="ai-run-btn">Run Analysis</button>
            </div>
          </div>
          <div id="overviewAiAnalysisBody" class="ai-analysis-body">
            <div id="overviewAiAnalysisContent" class="ai-analysis-content"></div>
          </div>
        </div>

        <div class="overview-tiles-grid">
          <div class="overview-metric-tile">
            <div class="metric-tile-header">
              <div class="metric-tile-title-wrapper">
                <span class="metric-tile-title" title="Total income from sales and services before any deductions">Revenue</span>
                <button class="metric-info-btn" data-info="Total income from sales and services before any deductions" aria-label="Info about Revenue">‚ìò</button>
              </div>
              <div class="metric-tile-buttons">
                <button class="chart-expand-btn" data-chart="overviewRevenueChart" data-title="Revenue" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
                <button class="chart-close-btn" data-metric="showRevenue" title="Hide this metric"><svg viewBox="0 0 16 16" width="12" height="12"><path fill="currentColor" d="M2.5 1L8 6.5 13.5 1 15 2.5 9.5 8 15 13.5 13.5 15 8 9.5 2.5 15 1 13.5 6.5 8 1 2.5 2.5 1z"/></svg></button>
              </div>
            </div>
            <div class="metric-tile-subtitle" id="overviewRevenueSubtitle"></div>
            <canvas id="overviewRevenueChart"></canvas>
            <div class="metric-stats" id="overviewRevenueStats">
              <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="revenueAvg">-</div></div>
              <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="revenueHigh">-</div><div class="stat-period" id="revenueHighPeriod"></div></div>
              <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="revenueLow">-</div><div class="stat-period" id="revenueLowPeriod"></div></div>
              <div class="stat-box"><div class="stat-label" id="revenueGrowthLabel">CAGR</div><div class="stat-value" id="revenueCagr">-</div></div>
            </div>
            <button class="chart-data-toggle" data-target="overviewRevenueTable">Expand</button>
            <div class="chart-data-wrapper collapsed" id="overviewRevenueTable"><table class="overview-data-table"><thead></thead><tbody></tbody></table></div>
          </div>
          <div class="overview-metric-tile">
            <div class="metric-tile-header">
              <div class="metric-tile-title-wrapper">
                <span class="metric-tile-title" title="Gross Profit as a percentage of Revenue - measures production efficiency">Gross Profit Margin %</span>
                <button class="metric-info-btn" data-info="Gross Profit as a percentage of Revenue - measures production efficiency" aria-label="Info about Gross Profit Margin">‚ìò</button>
              </div>
              <div class="metric-tile-buttons">
                <button class="chart-expand-btn" data-chart="overviewGrossMarginChart" data-title="Gross Profit Margin %" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
                <button class="chart-close-btn" data-metric="showGrossMargin" title="Hide this metric"><svg viewBox="0 0 16 16" width="12" height="12"><path fill="currentColor" d="M2.5 1L8 6.5 13.5 1 15 2.5 9.5 8 15 13.5 13.5 15 8 9.5 2.5 15 1 13.5 6.5 8 1 2.5 2.5 1z"/></svg></button>
              </div>
            </div>
            <div class="metric-tile-subtitle" id="overviewGrossMarginSubtitle"></div>
            <canvas id="overviewGrossMarginChart"></canvas>
            <div class="metric-stats" id="overviewGrossMarginStats">
              <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="grossMarginAvg">-</div></div>
              <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="grossMarginHigh">-</div><div class="stat-period" id="grossMarginHighPeriod"></div></div>
              <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="grossMarginLow">-</div><div class="stat-period" id="grossMarginLowPeriod"></div></div>
              <div class="stat-box"><div class="stat-label" id="grossMarginGrowthLabel">CAGR</div><div class="stat-value" id="grossMarginCagr">-</div></div>
            </div>
            <button class="chart-data-toggle" data-target="overviewGrossMarginTable">Expand</button>
            <div class="chart-data-wrapper collapsed" id="overviewGrossMarginTable"><table class="overview-data-table"><thead></thead><tbody></tbody></table></div>
          </div>
          <div class="overview-metric-tile">
            <div class="metric-tile-header">
              <div class="metric-tile-title-wrapper">
                <span class="metric-tile-title" title="Operating Profit as a percentage of Revenue - measures overall operational efficiency">Operating Profit %</span>
                <button class="metric-info-btn" data-info="Operating Profit as a percentage of Revenue - measures overall operational efficiency" aria-label="Info about Operating Profit %">‚ìò</button>
              </div>
              <div class="metric-tile-buttons">
                <button class="chart-expand-btn" data-chart="overviewOpMarginChart" data-title="Operating Profit %" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
                <button class="chart-close-btn" data-metric="showOpMargin" title="Hide this metric"><svg viewBox="0 0 16 16" width="12" height="12"><path fill="currentColor" d="M2.5 1L8 6.5 13.5 1 15 2.5 9.5 8 15 13.5 13.5 15 8 9.5 2.5 15 1 13.5 6.5 8 1 2.5 2.5 1z"/></svg></button>
              </div>
            </div>
            <div class="metric-tile-subtitle" id="overviewOpMarginSubtitle"></div>
            <canvas id="overviewOpMarginChart"></canvas>
            <div class="metric-stats" id="overviewOpMarginStats">
              <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="opMarginAvg">-</div></div>
              <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="opMarginHigh">-</div><div class="stat-period" id="opMarginHighPeriod"></div></div>
              <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="opMarginLow">-</div><div class="stat-period" id="opMarginLowPeriod"></div></div>
              <div class="stat-box"><div class="stat-label" id="opMarginGrowthLabel">CAGR</div><div class="stat-value" id="opMarginCagr">-</div></div>
            </div>
            <button class="chart-data-toggle" data-target="overviewOpMarginTable">Expand</button>
            <div class="chart-data-wrapper collapsed" id="overviewOpMarginTable"><table class="overview-data-table"><thead></thead><tbody></tbody></table></div>
          </div>
          <div class="overview-metric-tile">
            <div class="metric-tile-header">
              <div class="metric-tile-title-wrapper">
                <span class="metric-tile-title" title="Total cash and cash equivalents including checking, savings, and undeposited funds">Cash</span>
                <button class="metric-info-btn" data-info="Total cash and cash equivalents including checking, savings, and undeposited funds" aria-label="Info about Cash">‚ìò</button>
              </div>
              <div class="metric-tile-buttons">
                <button class="chart-expand-btn" data-chart="overviewCashChart" data-title="Cash" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
                <button class="chart-close-btn" data-metric="showCash" title="Hide this metric"><svg viewBox="0 0 16 16" width="12" height="12"><path fill="currentColor" d="M2.5 1L8 6.5 13.5 1 15 2.5 9.5 8 15 13.5 13.5 15 8 9.5 2.5 15 1 13.5 6.5 8 1 2.5 2.5 1z"/></svg></button>
              </div>
            </div>
            <div class="metric-tile-subtitle" id="overviewCashSubtitle"></div>
            <canvas id="overviewCashChart"></canvas>
            <div class="metric-stats" id="overviewCashStats">
              <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="cashAvg">-</div></div>
              <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="cashHigh">-</div><div class="stat-period" id="cashHighPeriod"></div></div>
              <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="cashLow">-</div><div class="stat-period" id="cashLowPeriod"></div></div>
              <div class="stat-box"><div class="stat-label" id="cashGrowthLabel">CAGR</div><div class="stat-value" id="cashCagr">-</div></div>
            </div>
            <button class="chart-data-toggle" data-target="overviewCashTable">Expand</button>
            <div class="chart-data-wrapper collapsed" id="overviewCashTable"><table class="overview-data-table"><thead></thead><tbody></tbody></table></div>
          </div>
          <div class="overview-metric-tile">
            <div class="metric-tile-header">
              <div class="metric-tile-title-wrapper">
                <span class="metric-tile-title" title="Accounts Receivable divided by Accounts Payable (excluding retainage) - measures collection vs payment balance">AR/AP Ratio</span>
                <button class="metric-info-btn" data-info="Accounts Receivable divided by Accounts Payable (excluding retainage) - measures collection vs payment balance. Above 1.0 means more receivables than payables." aria-label="Info about AR/AP Ratio">‚ìò</button>
              </div>
              <div class="metric-tile-buttons">
                <button class="chart-expand-btn" data-chart="overviewArApRatioChart" data-title="AR/AP Ratio" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
                <button class="chart-close-btn" data-metric="showArApRatio" title="Hide this metric"><svg viewBox="0 0 16 16" width="12" height="12"><path fill="currentColor" d="M2.5 1L8 6.5 13.5 1 15 2.5 9.5 8 15 13.5 13.5 15 8 9.5 2.5 15 1 13.5 6.5 8 1 2.5 2.5 1z"/></svg></button>
              </div>
            </div>
            <div class="metric-tile-subtitle" id="overviewArApRatioSubtitle"></div>
            <canvas id="overviewArApRatioChart"></canvas>
            <div class="metric-stats" id="overviewArApRatioStats">
              <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="arApRatioAvg">-</div></div>
              <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="arApRatioHigh">-</div><div class="stat-period" id="arApRatioHighPeriod"></div></div>
              <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="arApRatioLow">-</div><div class="stat-period" id="arApRatioLowPeriod"></div></div>
              <div class="stat-box"><div class="stat-label" id="arApRatioGrowthLabel">CAGR</div><div class="stat-value" id="arApRatioCagr">-</div></div>
            </div>
            <button class="chart-data-toggle" data-target="overviewArApRatioTable">Expand</button>
            <div class="chart-data-wrapper collapsed" id="overviewArApRatioTable"><table class="overview-data-table"><thead></thead><tbody></tbody></table></div>
          </div>
          <div class="overview-metric-tile">
            <div class="metric-tile-header">
              <div class="metric-tile-title-wrapper">
                <span class="metric-tile-title" title="Net billing position: Underbillings minus Overbillings. Positive = overbilled (collected ahead), Negative = underbilled (costs ahead of billing)">Net Over/(Under) Billing</span>
                <button class="metric-info-btn" data-info="Net billing position calculated as Underbillings minus Overbillings from GL. Positive values indicate overbilling (billings ahead of costs), negative values indicate underbilling (costs ahead of billings)." aria-label="Info about Net Over/(Under) Billing">‚ìò</button>
              </div>
              <div class="metric-tile-buttons">
                <button class="chart-expand-btn" data-chart="overviewOverUnderChart" data-title="Net Over/(Under) Billing" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
                <button class="chart-close-btn" data-metric="showOverUnder" title="Hide this metric"><svg viewBox="0 0 16 16" width="12" height="12"><path fill="currentColor" d="M2.5 1L8 6.5 13.5 1 15 2.5 9.5 8 15 13.5 13.5 15 8 9.5 2.5 15 1 13.5 6.5 8 1 2.5 2.5 1z"/></svg></button>
              </div>
            </div>
            <div class="metric-tile-subtitle" id="overviewOverUnderSubtitle"></div>
            <canvas id="overviewOverUnderChart"></canvas>
            <div class="metric-stats" id="overviewOverUnderStats">
              <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="overUnderAvg">-</div></div>
              <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="overUnderHigh">-</div><div class="stat-period" id="overUnderHighPeriod"></div></div>
              <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="overUnderLow">-</div><div class="stat-period" id="overUnderLowPeriod"></div></div>
              <div class="stat-box"><div class="stat-label">Current</div><div class="stat-value" id="overUnderCurrent">-</div></div>
            </div>
            <button class="chart-data-toggle" data-target="overviewOverUnderTable">Expand</button>
            <div class="chart-data-wrapper collapsed" id="overviewOverUnderTable"><table class="overview-data-table"><thead></thead><tbody></tbody></table></div>
          </div>
        </div>
      </section>

      <!-- ============================================================
           ACCOUNT VIEW
      ============================================================= -->
      <section id="accounts" class="dashboard-section">
        <h2>Account Detail</h2>
        <div class="data-as-of">Data as of: <span id="acctDataAsOf"></span></div>

        <div class="config-panel">
          <div class="config-header" data-target="acctConfigBody">
            <span class="config-toggle">‚ñº</span>
            <span class="config-title">Configuration Options</span>
            <button class="config-expand-btn">Expand ‚ñº</button>
          </div>
          <div class="config-body" id="acctConfigBody">
            <div class="rev-controls">
              <label style="display: block; font-weight: 600; margin-bottom: 8px;">Account:</label>
              <select id="acctSelect" style="display: block; margin-bottom: 12px; width: 100%;"></select>

              <div class="overview-config-box">
                <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Time Period:</div>
                <div class="dropdown-stack">
                  <div class="dropdown-row">
                    <label>View:</label>
                    <select id="acctViewType">
                      <option value="monthly">Monthly</option>
                      <option value="quarterly">Quarterly</option>
                      <option value="annual">Annual</option>
                    </select>
                  </div>
                  <div id="acctYearWrapper" class="dropdown-row">
                    <label>Year:</label>
                    <select id="acctYear"></select>
                  </div>
                </div>
              </div>

              <div id="acctRangeWrapper" class="range-wrapper year-range-inline hidden">
                <label>Year Range:</label>
                <span id="acctRangeStartLabel" class="year-label">2015</span>
                <input type="range" id="acctRangeStart" min="2015" max="2025" value="2015" step="1" class="year-slider">
                <span class="range-separator">to</span>
                <input type="range" id="acctRangeEnd" min="2015" max="2025" value="2025" step="1" class="year-slider">
                <span id="acctRangeEndLabel" class="year-label">2025</span>
              </div>

              <div class="overview-config-box">
                <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Visuals:</div>
                <div class="checkbox-stack">
                  <label class="checkbox-label">
                    <input type="checkbox" id="acctCompare">
                    Compare to Prior Year
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="acctTrendline">
                    Show Trendline
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="acctDataLabels">
                    Show Data Labels
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="acctExcludeCurrent" checked>
                    <span id="acctExcludeLabel">Exclude Month in Progress</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="acctAiAnalysisPanel" class="ai-analysis-panel">
          <div class="ai-analysis-header" id="acctAiAnalysisHeader">
            <div class="ai-analysis-header-left">
              <span class="ai-analysis-toggle-icon">‚ñº</span>
              <span class="ai-analysis-title">AI ANALYSIS</span>
              <button type="button" id="acctAiAnalyzeBtn" class="ai-run-btn">Run Analysis</button>
            </div>
          </div>
          <div id="acctAiAnalysisBody" class="ai-analysis-body">
            <div id="acctAiAnalysisContent" class="ai-analysis-content"></div>
          </div>
        </div>

        <!-- Account Chart with Summary Tiles -->
        <div class="chart-with-tiles">
          <div class="summary-tiles" id="acctSummaryTiles">
            <div class="summary-tile">
              <div class="tile-label">Average</div>
              <div class="tile-value" id="acctAvgValue">$0</div>
            </div>
            <div class="summary-tile">
              <div class="tile-label">Largest</div>
              <div class="tile-value" id="acctMaxValue">$0</div>
              <div class="tile-sub" id="acctMaxPeriod">-</div>
            </div>
            <div class="summary-tile">
              <div class="tile-label">Smallest</div>
              <div class="tile-value" id="acctMinValue">$0</div>
              <div class="tile-sub" id="acctMinPeriod">-</div>
            </div>
            <div class="summary-tile">
              <div class="tile-label">CAGR</div>
              <div class="tile-value" id="acctCagrValue">0%</div>
            </div>
          </div>
          <div class="chart-box" id="acctChartBox">
            <div id="acctLoadingSpinner" class="loading-spinner hidden">
              <div class="spinner"></div>
              <span>Loading data...</span>
            </div>
            <div class="chart-header-row">
              <div class="chart-title">
                <div id="acctChartTitleLine1">Account Activity</div>
                <div id="acctChartTitleLine2">Monthly ‚Äì 2025</div>
                <div id="acctChartUpdated" class="chart-updated">Updated:</div>
              </div>
              <button class="chart-expand-btn" data-chart="acctChart" data-title="Account Detail" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
            </div>
            <canvas id="acctChart" style="width:100%; height:300px;"></canvas>
            <div id="acctPartialLegend" class="partial-legend hidden">
              <span class="partial-indicator"></span> Partial period (month in progress)
            </div>
            <button class="breakdown-expand-btn" data-target="acctTableWrapper">
              <span class="expand-text">Expand</span>
              <span class="expand-arrow">‚ñº</span>
            </button>
            <div class="breakdown-table-wrapper collapsed" id="acctTableWrapper">
              <div class="table-header-row">
                <span>Account Breakdown</span>
                <button class="export-table-btn" id="acctTableExportBtn" type="button">Export CSV</button>
              </div>
              <div class="table-scroll">
                <table id="acctTable" class="breakdown-table acct-table">
                  <thead id="acctTableHead"></thead>
                  <tbody id="acctTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </section>

      <!-- ============================================================
           INCOME STATEMENT
      ============================================================= -->
      <section id="incomeStatement" class="dashboard-section">
        <h2>Income Statement</h2>
        <div class="data-as-of">Data as of: <span id="isDataAsOf"></span></div>

        <div class="config-panel">
          <div class="config-header" data-target="isConfigBody">
            <span class="config-toggle">‚ñº</span>
            <span class="config-title">Configuration Options</span>
            <button class="config-expand-btn">Expand ‚ñº</button>
          </div>
          <div class="config-body" id="isConfigBody">
            <div class="is-controls">
              <div class="overview-config-box">
                <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Time Period:</div>
                <div class="is-period-stack">
                  <div class="is-period-row">
                    <label>View:</label>
                    <select id="isViewMode">
                      <option value="single">Single Period</option>
                      <option value="matrix">Matrix</option>
                    </select>
                  </div>
                  <div class="is-period-row">
                    <label>Period Type:</label>
                    <select id="isPeriodType">
                      <option value="month">Month</option>
                      <option value="quarter">Quarter</option>
                      <option value="year">Year</option>
                      <option value="ytd">YTD</option>
                      <option value="ttm">TTM</option>
                    </select>
                  </div>
                  <div class="is-period-row">
                    <label id="isPeriodSelectLabel">Period:</label>
                    <select id="isPeriodSelect"></select>
                  </div>
                </div>
              </div>

              <div class="is-compare-detail-wrapper">
                <div id="isSingleControls" class="is-options-stack is-compare-box">
                  <label class="config-section-label">Compare:</label>
                  <div class="radio-group-stacked">
                    <label class="radio-label"><input type="radio" name="isCompareRadio" value="none" checked> None</label>
                    <label class="radio-label"><input type="radio" name="isCompareRadio" value="prior_period"> Prior Period</label>
                    <label class="radio-label"><input type="radio" name="isCompareRadio" value="prior_year"> Prior Year</label>
                  </div>
                </div>

                <div class="is-options-stack is-detail-box">
                  <label class="config-section-label">Detail:</label>
                  <div class="radio-group-stacked">
                    <label class="radio-label"><input type="radio" name="isDetailLevel" value="summary" checked> Summary</label>
                    <label class="radio-label"><input type="radio" name="isDetailLevel" value="medium"> Medium</label>
                    <label class="radio-label"><input type="radio" name="isDetailLevel" value="account"> Account</label>
                  </div>
                </div>
              </div>

              <div id="isMatrixControls" class="hidden">
                <div id="isMatrixYearControls" class="range-wrapper year-range-inline hidden">
                  <label>Year Range:</label>
                  <span id="isMatrixYearStartLabel" class="year-label">2020</span>
                  <input type="range" id="isMatrixYearStart" min="2015" max="2025" value="2020" step="1" class="year-slider">
                  <span class="range-separator">to</span>
                  <input type="range" id="isMatrixYearEnd" min="2015" max="2025" value="2025" step="1" class="year-slider">
                  <span id="isMatrixYearEndLabel" class="year-label">2025</span>
                </div>
              </div>

              <div class="is-options-stack">
                <label class="is-checkbox-label small" id="isShowSubtotalWrapper">
                  <input type="checkbox" id="isShowSubtotal">
                  Show Subtotal
                </label>
                <label class="is-checkbox-label small">
                  <input type="checkbox" id="isShowThousands" checked>
                  Show in Thousands
                </label>
                <label class="is-checkbox-label small">
                  <input type="checkbox" id="isExcludeCurrent" checked>
                  Exclude Month in Progress
                </label>
                <label class="is-checkbox-label small">
                  <input type="checkbox" id="isWaterfallDataLabels" checked>
                  Waterfall Data Labels
                </label>
              </div>
            </div>
          </div>
        </div>

        <div id="isAiAnalysisPanel" class="ai-analysis-panel">
          <div class="ai-analysis-header" id="isAiAnalysisHeader">
            <div class="ai-analysis-header-left">
              <span class="ai-analysis-toggle-icon">‚ñº</span>
              <span class="ai-analysis-title">AI ANALYSIS</span>
              <button type="button" id="isAiAnalyzeBtn" class="ai-run-btn">Run Analysis</button>
            </div>
          </div>
          <div id="isAiAnalysisBody" class="ai-analysis-body">
            <div id="isAiAnalysisContent" class="ai-analysis-content"></div>
          </div>
        </div>

        <!-- Revenue to Operating Income Waterfall Chart (Single Period Only) -->
        <div id="isWaterfallSection" class="waterfall-section">
          <div class="waterfall-header">
            <h3 class="jo-section-header">Revenue to Operating Income Waterfall</h3>
          </div>
          <p class="waterfall-description">Flow from revenue through direct costs, indirect costs, and operating expenses to operating income.</p>
          <div class="waterfall-chart-container">
            <canvas id="isWaterfallChart"></canvas>
          </div>
        </div>

        <div class="is-table-box">
          <div class="report-header" id="isReportHeader">
            <div class="report-header-company">FTG Builders</div>
            <div class="report-header-title">Income Statement</div>
            <div class="report-header-period" id="isReportPeriod"></div>
          </div>
          <table id="incomeStatementTable" class="is-table">
            <thead id="isTableHead"></thead>
            <tbody id="isTableBody"></tbody>
          </table>
          <div id="isPartialFootnote" class="partial-footnote hidden">
            <span class="is-partial-indicator">*</span> Partial period
          </div>
        </div>
      </section>

      <!-- ============================================================
           BALANCE SHEET
      ============================================================= -->
      <section id="balanceSheet" class="dashboard-section">
        <h2>Balance Sheet</h2>
        <div class="data-as-of">Data as of: <span id="bsDataAsOf"></span></div>

        <div class="config-panel">
          <div class="config-header" data-target="bsConfigBody">
            <span class="config-toggle">‚ñº</span>
            <span class="config-title">Configuration Options</span>
            <button class="config-expand-btn">Expand ‚ñº</button>
          </div>
          <div class="config-body" id="bsConfigBody">
            <div class="is-controls">
              <div class="overview-config-box">
                <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Time Period:</div>
                <div class="is-period-stack">
                  <div class="is-period-row">
                    <label>View:</label>
                    <select id="bsViewMode">
                      <option value="single">Single Period</option>
                      <option value="matrix">Matrix</option>
                    </select>
                  </div>
                  <div class="is-period-row" id="bsPeriodTypeRow" style="display: none;">
                    <label>Period Type:</label>
                    <select id="bsPeriodType">
                      <option value="month">Month</option>
                      <option value="quarter">Quarter</option>
                      <option value="annual">Annual</option>
                    </select>
                  </div>
                  <div class="is-period-row" id="bsSinglePeriodRow">
                    <label>As of Date:</label>
                    <select id="bsPeriodSelect"></select>
                  </div>
                  <div class="is-period-row" id="bsMatrixYearRow" style="display: none;">
                    <label>Year:</label>
                    <select id="bsMatrixYear"></select>
                  </div>
                </div>
              </div>

              <div id="bsMatrixRangeControls" class="range-wrapper year-range-inline" style="display: none;">
                <label>Year Range:</label>
                <span id="bsMatrixYearStartLabel" class="year-label">2020</span>
                <input type="range" id="bsMatrixYearStart" min="2015" max="2025" value="2020" step="1" class="year-slider">
                <span class="range-separator">to</span>
                <input type="range" id="bsMatrixYearEnd" min="2015" max="2025" value="2025" step="1" class="year-slider">
                <span id="bsMatrixYearEndLabel" class="year-label">2025</span>
              </div>

              <div class="is-compare-detail-wrapper">
                <div class="is-options-stack is-compare-box" id="bsSingleCompareBox">
                  <label style="font-weight: 600;">Compare:</label>
                  <div class="radio-group-stacked">
                    <label class="radio-label"><input type="radio" name="bsCompareRadio" value="none" checked> None</label>
                    <label class="radio-label"><input type="radio" name="bsCompareRadio" value="prior_month"> Prior Month</label>
                    <label class="radio-label"><input type="radio" name="bsCompareRadio" value="prior_year"> Prior Year</label>
                  </div>
                </div>

                <div class="is-options-stack is-detail-box">
                  <label style="font-weight: 600;">Detail:</label>
                  <div class="radio-group-stacked">
                    <label class="radio-label"><input type="radio" name="bsDetailLevel" value="summary" checked> Summary</label>
                    <label class="radio-label"><input type="radio" name="bsDetailLevel" value="medium"> Medium</label>
                    <label class="radio-label"><input type="radio" name="bsDetailLevel" value="account"> Account</label>
                  </div>
                </div>
              </div>

              <div class="is-options-stack">
                <label class="is-checkbox-label small">
                  <input type="checkbox" id="bsShowThousands" checked>
                  Show in Thousands
                </label>
                <label class="is-checkbox-label small">
                  <input type="checkbox" id="bsExcludeCurrentMonth" checked>
                  Exclude Month in Progress
                </label>
              </div>
            </div>
          </div>
        </div>

        <div id="bsAiAnalysisPanel" class="ai-analysis-panel">
          <div class="ai-analysis-header" id="bsAiAnalysisHeader">
            <div class="ai-analysis-header-left">
              <span class="ai-analysis-toggle-icon">‚ñº</span>
              <span class="ai-analysis-title">AI ANALYSIS</span>
              <button type="button" id="bsAiAnalyzeBtn" class="ai-run-btn">Run Analysis</button>
            </div>
          </div>
          <div id="bsAiAnalysisBody" class="ai-analysis-body">
            <div id="bsAiAnalysisContent" class="ai-analysis-content"></div>
          </div>
        </div>

        <div class="is-table-box">
          <div class="report-header" id="bsReportHeader">
            <div class="report-header-company">FTG Builders</div>
            <div class="report-header-title">Balance Sheet</div>
            <div class="report-header-period" id="bsReportPeriod"></div>
          </div>
          <table id="balanceSheetTable" class="is-table">
            <thead id="bsTableHead"></thead>
            <tbody id="bsTableBody"></tbody>
          </table>
          <div id="bsPartialFootnote" class="partial-footnote hidden">
            <span class="is-partial-indicator">*</span> Partial period (month in progress)
          </div>
        </div>
      </section>

      <!-- ============================================================
           STATEMENT OF CASH FLOWS
      ============================================================= -->
      <section id="cashFlows" class="dashboard-section">
        <h2>Statement of Cash Flows</h2>
        <div class="data-as-of">Data as of: <span id="cfDataAsOf"></span></div>

        <div class="config-panel">
          <div class="config-header" data-target="cfConfigBody">
            <span class="config-toggle">‚ñº</span>
            <span class="config-title">Configuration Options</span>
            <button class="config-expand-btn">Expand ‚ñº</button>
          </div>
          <div class="config-body" id="cfConfigBody">
            <div class="is-controls">
              <div class="overview-config-box">
                <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Time Period:</div>
                <div class="is-period-stack">
                  <div class="is-period-row">
                    <label>View:</label>
                    <select id="cfViewMode">
                      <option value="single">Single Period</option>
                      <option value="matrix">Matrix</option>
                    </select>
                  </div>
                  <div class="is-period-row">
                    <label>Period Type:</label>
                    <select id="cfPeriodType">
                      <option value="month">Month</option>
                      <option value="quarter">Quarter</option>
                      <option value="year">Year</option>
                      <option value="ytd">YTD</option>
                      <option value="ttm">TTM</option>
                    </select>
                  </div>
                  <div class="is-period-row">
                    <label id="cfPeriodSelectLabel">Period:</label>
                    <select id="cfPeriodSelect"></select>
                  </div>
                </div>
              </div>

              <div class="is-compare-detail-wrapper">
                <div id="cfSingleControls" class="is-options-stack is-compare-box">
                  <label style="font-weight: 600;">Compare:</label>
                  <div class="radio-group-stacked">
                    <label class="radio-label"><input type="radio" name="cfCompareRadio" value="none" checked> None</label>
                    <label class="radio-label"><input type="radio" name="cfCompareRadio" value="prior_period"> Prior Period</label>
                    <label class="radio-label"><input type="radio" name="cfCompareRadio" value="prior_year"> Prior Year</label>
                  </div>
                </div>

                <div class="is-options-stack is-detail-box">
                  <label style="font-weight: 600;">Detail:</label>
                  <div class="radio-group-stacked">
                    <label class="radio-label"><input type="radio" name="cfDetailLevel" value="summary" checked> Summary</label>
                    <label class="radio-label"><input type="radio" name="cfDetailLevel" value="detailed"> Detailed</label>
                  </div>
                </div>
              </div>

              <div id="cfMatrixControls" class="hidden">
                <div id="cfMatrixYearControls" class="range-wrapper year-range-inline hidden">
                  <label>Year Range:</label>
                  <span id="cfMatrixYearStartLabel" class="year-label">2020</span>
                  <input type="range" id="cfMatrixYearStart" min="2015" max="2025" value="2020" step="1" class="year-slider">
                  <span class="range-separator">to</span>
                  <input type="range" id="cfMatrixYearEnd" min="2015" max="2025" value="2025" step="1" class="year-slider">
                  <span id="cfMatrixYearEndLabel" class="year-label">2025</span>
                </div>
              </div>

              <div class="is-options-stack">
                <label class="is-checkbox-label small" id="cfShowSubtotalWrapper">
                  <input type="checkbox" id="cfShowSubtotal">
                  Show Subtotal
                </label>
                <label class="is-checkbox-label small">
                  <input type="checkbox" id="cfShowThousands" checked>
                  Show in Thousands
                </label>
                <label class="is-checkbox-label small">
                  <input type="checkbox" id="cfExcludeCurrent" checked>
                  Exclude Month in Progress
                </label>
                <label class="is-checkbox-label small">
                  <input type="checkbox" id="cfExcludeSchwab" checked>
                  Exclude Schwab (1004)
                </label>
              </div>
            </div>
          </div>
        </div>

        <div id="cfAiAnalysisPanel" class="ai-analysis-panel">
          <div class="ai-analysis-header" id="cfAiAnalysisHeader">
            <div class="ai-analysis-header-left">
              <span class="ai-analysis-toggle-icon">‚ñº</span>
              <span class="ai-analysis-title">AI ANALYSIS</span>
              <button type="button" id="cfAiAnalyzeBtn" class="ai-run-btn">Run Analysis</button>
            </div>
          </div>
          <div id="cfAiAnalysisBody" class="ai-analysis-body">
            <div id="cfAiAnalysisContent" class="ai-analysis-content"></div>
          </div>
        </div>

        <div class="is-table-box">
          <div class="report-header" id="cfReportHeader">
            <div class="report-header-company">FTG Builders</div>
            <div class="report-header-title">Statement of Cash Flows</div>
            <div class="report-header-period" id="cfReportPeriod"></div>
          </div>
          <table id="cashFlowTable" class="is-table">
            <thead id="cfTableHead"></thead>
            <tbody id="cfTableBody"></tbody>
          </table>
          <div id="cfPartialFootnote" class="partial-footnote hidden">
            <span class="is-partial-indicator">*</span> Partial period
          </div>
        </div>
      </section>

      <!-- ============================================================
           JOB OVERVIEW
      ============================================================= -->
      <section id="jobOverview" class="dashboard-section">
        <h2>Job and PM Overview</h2>
        <div class="section-subtitle">Foundation</div>
        <div class="data-as-of">Data as of: <span id="jobOverviewDataAsOf">-</span></div>

        <!-- PM Tabs Bar -->
        <div class="pm-tabs-bar" id="joPmTabsBar">
          <span class="pm-tabs-bar-label">Project Manager</span>
          <div class="pm-tabs-container" id="joPmTabs">
            <span class="pm-tabs-loading">Loading...</span>
          </div>
        </div>

        <!-- Status Filter Row -->
        <div class="status-filter-bar" id="joStatusBar">
          <div class="status-filter-group">
            <span class="status-filter-label">Status:</span>
            <div class="status-checkboxes">
              <label class="status-checkbox-label">
                <input type="checkbox" id="joStatusActive" value="A" checked>
                Active
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="joStatusInactive" value="I">
                Inactive
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="joStatusClosed" value="C">
                Closed
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="joStatusOverhead" value="O">
                Overhead
              </label>
            </div>
          </div>
        </div>

        <!-- AI Analysis Panel -->
        <div id="joAiAnalysisPanel" class="ai-analysis-panel">
          <div class="ai-analysis-header" id="joAiAnalysisHeader">
            <div class="ai-analysis-header-left">
              <span class="ai-analysis-toggle-icon">‚ñº</span>
              <span class="ai-analysis-title">AI ANALYSIS</span>
              <button type="button" id="joAiAnalyzeBtn" class="ai-run-btn">Run Analysis</button>
            </div>
          </div>
          <div id="joAiAnalysisBody" class="ai-analysis-body">
            <div id="joAiAnalysisContent" class="ai-analysis-content"></div>
          </div>
        </div>

        <!-- Profitability Heat Map -->
        <div class="profitability-heatmap-section">
          <div class="heatmap-header">
            <h3 class="jo-section-header">Profitability Heat Map</h3>
          </div>
          <p class="heatmap-description" id="heatmapDescription">Profit margin by Project Manager and job size. Darker green = higher margin, red = negative margin.</p>
          <div class="heatmap-legend">
            <span class="legend-label">Loss</span>
            <div class="legend-gradient"></div>
            <span class="legend-label">High Profit</span>
          </div>
          <div class="heatmap-container" id="profitabilityHeatmap">
            <div class="loading-spinner">Loading heat map data...</div>
          </div>
        </div>

        <!-- ============================================================
             PM PERFORMANCE SECTION
        ============================================================= -->
        
        <!-- PM Report Desktop Layout: Left (Radar + Metrics) | Right (Charts Stack) -->
        <div class="pmr-desktop-layout jo-pmr-section">
          <!-- Left Column: Radar + Metrics -->
          <div class="pmr-left-column">
            <!-- PM Performance Radar Chart -->
            <div class="pm-radar-section">
              <div class="radar-header">
                <h3 class="pmr-section-title">PM Performance Radar</h3>
              </div>
              <p class="radar-description">Compare selected PM performance across key metrics vs portfolio average. Higher values = better performance.</p>
              <div class="radar-chart-container">
                <canvas id="joPmRadarChart"></canvas>
              </div>
              <div class="radar-legend-box" id="joRadarLegendBox"></div>
            </div>

            <!-- Key Metrics Summary - 4 columns layout -->
            <div class="pmr-metrics-wrapper">
              <h3 class="pmr-section-title">Key Metrics</h3>
              <!-- Row 1: 4 tiles -->
              <div class="pmr-metrics-row pmr-metrics-4col">
                <div class="pmr-metric-tile">
                  <div class="pmr-metric-label"># of Jobs</div>
                  <div class="pmr-metric-value" id="joPmrTotalJobs">-</div>
                </div>
                <div class="pmr-metric-tile">
                  <div class="pmr-metric-label">Contract Value</div>
                  <div class="pmr-metric-value" id="joPmrTotalContract">-</div>
                </div>
                <div class="pmr-metric-tile">
                  <div class="pmr-metric-label">Billed Revenue</div>
                  <div class="pmr-metric-value" id="joPmrBilledRevenue">-</div>
                </div>
                <div class="pmr-metric-tile">
                  <div class="pmr-metric-label">Earned Revenue</div>
                  <div class="pmr-metric-value" id="joPmrTotalEarnedRevenue">-</div>
                </div>
              </div>

              <!-- Row 2: 4 tiles -->
              <div class="pmr-metrics-row pmr-metrics-4col">
                <div class="pmr-metric-tile">
                  <div class="pmr-metric-label">Billed Last Month</div>
                  <div class="pmr-metric-value" id="joPmrBilledLastMonth">-</div>
                </div>
                <div class="pmr-metric-tile">
                  <div class="pmr-metric-label">AR Exposure</div>
                  <div class="pmr-metric-value" id="joPmrArExposure">-</div>
                </div>
                <div class="pmr-metric-tile">
                  <div class="pmr-metric-label">Backlog</div>
                  <div class="pmr-metric-value" id="joPmrBacklog">-</div>
                </div>
                <div class="pmr-metric-tile">
                  <div class="pmr-metric-label">Net Over/(Under)</div>
                  <div class="pmr-metric-value" id="joPmrNetOverUnder">-</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Charts Stack -->
          <div class="pmr-right-column">
            <div class="pmr-chart-container">
              <h4 class="pmr-chart-title">Margin Distribution</h4>
              <canvas id="joPmrMarginChart" width="280" height="150"></canvas>
            </div>
            <div class="pmr-chart-container">
              <h4 class="pmr-chart-title">Budget vs Actual</h4>
              <canvas id="joPmrBudgetActualChart" width="280" height="150"></canvas>
            </div>
            <div class="pmr-chart-container">
              <h4 class="pmr-chart-title">Monthly Billing Trend</h4>
              <canvas id="joPmrBillingChart" width="280" height="150"></canvas>
            </div>
            <div class="pmr-chart-container">
              <h4 class="pmr-chart-title">AR Outstanding</h4>
              <canvas id="joPmrArAgingChart" width="280" height="150"></canvas>
            </div>
          </div>
        </div>

        <!-- Key Metrics by Project Manager -->
        <div class="job-overview-charts">
          <h3 class="jo-section-header">Key Metrics by Project Manager</h3>
          <div class="jo-chart-grid-3">
            <div class="overview-chart-card">
              <div class="chart-title"># of Jobs</div>
              <div class="chart-container">
                <canvas id="joPmJobsChart"></canvas>
              </div>
              <div class="chart-stats jo-chart-stats">
                <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="joPmJobsAvg">-</div></div>
                <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="joPmJobsHigh">-</div><div class="stat-period" id="joPmJobsHighName"></div></div>
                <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="joPmJobsLow">-</div><div class="stat-period" id="joPmJobsLowName"></div></div>
              </div>
            </div>
            <div class="overview-chart-card">
              <div class="chart-title">Contract Value</div>
              <div class="chart-container">
                <canvas id="joPmContractChart"></canvas>
              </div>
              <div class="chart-stats jo-chart-stats">
                <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="joPmContractAvg">-</div></div>
                <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="joPmContractHigh">-</div><div class="stat-period" id="joPmContractHighName"></div></div>
                <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="joPmContractLow">-</div><div class="stat-period" id="joPmContractLowName"></div></div>
              </div>
            </div>
            <div class="overview-chart-card">
              <div class="chart-title">Est. Profit Margin %</div>
              <div class="chart-container">
                <canvas id="joPmMarginChart"></canvas>
              </div>
              <div class="chart-stats jo-chart-stats">
                <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="joPmMarginAvg">-</div></div>
                <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="joPmMarginHigh">-</div><div class="stat-period" id="joPmMarginHighName"></div></div>
                <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="joPmMarginLow">-</div><div class="stat-period" id="joPmMarginLowName"></div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Key Metrics by Client -->
        <div class="job-overview-charts">
          <h3 class="jo-section-header">Key Metrics by Client</h3>
          <div class="jo-chart-grid-3">
            <div class="overview-chart-card">
              <div class="chart-title"># of Jobs</div>
              <div class="chart-container">
                <canvas id="joClientJobsChart"></canvas>
              </div>
              <div class="chart-stats jo-chart-stats">
                <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="joClientJobsAvg">-</div></div>
                <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="joClientJobsHigh">-</div><div class="stat-period" id="joClientJobsHighName"></div></div>
                <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="joClientJobsLow">-</div><div class="stat-period" id="joClientJobsLowName"></div></div>
              </div>
            </div>
            <div class="overview-chart-card">
              <div class="chart-title">Contract Value</div>
              <div class="chart-container">
                <canvas id="joClientContractChart"></canvas>
              </div>
              <div class="chart-stats jo-chart-stats">
                <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="joClientContractAvg">-</div></div>
                <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="joClientContractHigh">-</div><div class="stat-period" id="joClientContractHighName"></div></div>
                <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="joClientContractLow">-</div><div class="stat-period" id="joClientContractLowName"></div></div>
              </div>
            </div>
            <div class="overview-chart-card">
              <div class="chart-title">Est. Profit Margin %</div>
              <div class="chart-container">
                <canvas id="joClientMarginChart"></canvas>
              </div>
              <div class="chart-stats jo-chart-stats">
                <div class="stat-box"><div class="stat-label">Average</div><div class="stat-value" id="joClientMarginAvg">-</div></div>
                <div class="stat-box"><div class="stat-label">Highest</div><div class="stat-value" id="joClientMarginHigh">-</div><div class="stat-period" id="joClientMarginHighName"></div></div>
                <div class="stat-box"><div class="stat-label">Lowest</div><div class="stat-value" id="joClientMarginLow">-</div><div class="stat-period" id="joClientMarginLowName"></div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Client Summary Section -->
        <div class="pmr-section jo-pmr-section">
          <div class="pmr-section-header">
            <div>
              <h3 class="pmr-section-title">Client Summary</h3>
              <div class="pmr-section-desc">All clients with jobs for the selected PM/status</div>
            </div>
            <button class="pmr-toggle-btn" id="joClientSummaryToggle" onclick="toggleJoClientSummaryDetail()">Expand</button>
          </div>
          <div class="table-container pmr-table-container">
            <table class="data-table pmr-client-summary-table" id="joClientSummaryTable">
              <thead>
                <tr>
                  <th>Client</th>
                  <th class="text-right">Est. Contract</th>
                  <th class="text-right">Est. Cost</th>
                  <th class="text-right">Est. Profit</th>
                  <th class="text-right">Margin %</th>
                  <th class="text-right">Billed (Last Mo.)</th>
                  <th class="text-right">Billed to Date</th>
                  <th class="text-right">Cost to Date</th>
                </tr>
              </thead>
              <tbody id="joClientSummaryTableBody"></tbody>
            </table>
          </div>
          <div class="pmr-table-footer">
            <span id="joClientSummaryCount">0 clients</span>
          </div>
        </div>

        <!-- Over/Under Billing Section -->
        <div class="pmr-section jo-pmr-section">
          <div class="pmr-section-header">
            <div>
              <h3 class="pmr-section-title">Over/(Under) Billing</h3>
              <div class="pmr-section-desc">Jobs with billing variance for the selected PM/status</div>
            </div>
            <button class="pmr-toggle-btn" id="joOverUnderToggle" onclick="toggleJoOverUnderDetail()">Expand</button>
          </div>
          <div class="table-container pmr-table-container">
            <table class="data-table pmr-over-under-table" id="joOverUnderTable">
              <thead>
                <tr>
                  <th>Job #</th>
                  <th>Description</th>
                  <th>Client</th>
                  <th class="text-right">Contract</th>
                  <th class="text-right">Actual Cost</th>
                  <th class="text-right">% Complete</th>
                  <th class="text-right">Earned Rev</th>
                  <th class="text-right">Billed Rev</th>
                  <th class="text-right">Over/(Under)</th>
                </tr>
              </thead>
              <tbody id="joOverUnderTableBody"></tbody>
            </table>
          </div>
          <div class="pmr-table-footer">
            <span id="joOverUnderCount">0 jobs</span>
          </div>
        </div>

        <!-- Missing Budgets Section -->
        <div class="pmr-section jo-pmr-section">
          <div class="pmr-section-header">
            <div>
              <h3 class="pmr-section-title">Missing Budgets</h3>
              <div class="pmr-section-desc">Jobs with &gt;$2,500 actual cost but missing budgeted revenue or cost</div>
            </div>
            <button class="pmr-toggle-btn" id="joMissingBudgetsToggle" onclick="toggleJoMissingBudgetsDetail()">Expand</button>
          </div>
          <div class="table-container pmr-table-container">
            <table class="data-table pmr-missing-budgets-table" id="joMissingBudgetsTable">
              <thead>
                <tr>
                  <th>Job #</th>
                  <th>Description</th>
                  <th>Client</th>
                  <th>Status</th>
                  <th class="text-right">Actual Cost</th>
                  <th class="text-right">Budgeted Revenue</th>
                  <th class="text-right">Budgeted Cost</th>
                  <th>Issue</th>
                </tr>
              </thead>
              <tbody id="joMissingBudgetsTableBody"></tbody>
            </table>
          </div>
          <div class="pmr-table-footer">
            <span id="joMissingBudgetsCount">0 jobs</span>
          </div>
        </div>

      </section>

      <!-- ============================================================
           JOB BUDGETS
      ============================================================= -->
      <section id="jobBudgets" class="dashboard-section">
        <h2>Job Budgets</h2>
        <div class="data-as-of">Data as of: <span id="jobBudgetsDataAsOf">-</span></div>

        <!-- PM Tabs Bar -->
        <div class="pm-tabs-bar" id="jbPmTabsBar">
          <span class="pm-tabs-bar-label">Project Manager</span>
          <div class="pm-tabs-container" id="jbPmTabs">
            <span class="pm-tabs-loading">Loading...</span>
          </div>
        </div>

        <!-- Status Filter Row -->
        <div class="status-filter-bar" id="jbStatusBar">
          <div class="status-filter-group">
            <span class="status-filter-label">Status:</span>
            <div class="status-checkboxes">
              <label class="status-checkbox-label">
                <input type="checkbox" id="jobStatusActive" value="A" checked>
                Active
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="jobStatusInactive" value="I">
                Inactive
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="jobStatusClosed" value="C">
                Closed
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="jobStatusOverhead" value="O">
                Overhead
              </label>
            </div>
          </div>
        </div>

        <!-- AI Analysis Panel -->
        <div id="jbAiAnalysisPanel" class="ai-analysis-panel">
          <div class="ai-analysis-header" id="jbAiAnalysisHeader">
            <div class="ai-analysis-header-left">
              <span class="ai-analysis-toggle-icon">‚ñº</span>
              <span class="ai-analysis-title">AI ANALYSIS</span>
              <button type="button" id="jbAiAnalyzeBtn" class="ai-run-btn">Run Analysis</button>
            </div>
          </div>
          <div id="jbAiAnalysisBody" class="ai-analysis-body">
            <div id="jbAiAnalysisContent" class="ai-analysis-content"></div>
          </div>
        </div>

        <!-- Key Metrics Dashboard -->
        <div class="job-key-metrics-section">
          <h3 class="section-title">Key Metrics</h3>
          <div class="job-metrics-grid five-col">
            <div class="job-metric-card compact primary">
              <div class="metric-icon">üìã</div>
              <div class="metric-content">
                <div class="metric-value" id="jobTotalCount">-</div>
                <div class="metric-label">Total Jobs</div>
              </div>
            </div>
            <div class="job-metric-card compact">
              <div class="metric-icon">üí∞</div>
              <div class="metric-content">
                <div class="metric-value" id="jobTotalContract">-</div>
                <div class="metric-label">Contract Value</div>
              </div>
            </div>
            <div class="job-metric-card compact">
              <div class="metric-icon">üìä</div>
              <div class="metric-content">
                <div class="metric-value" id="jobTotalCost">-</div>
                <div class="metric-label">Est. Cost</div>
              </div>
            </div>
            <div class="job-metric-card compact profit">
              <div class="metric-icon">üìà</div>
              <div class="metric-content">
                <div class="metric-value" id="jobTotalProfit">-</div>
                <div class="metric-label">Est. Profit</div>
              </div>
            </div>
            <div class="job-metric-card compact margin">
              <div class="metric-icon">%</div>
              <div class="metric-content">
                <div class="metric-value" id="jobAvgMargin">-</div>
                <div class="metric-label">Avg Margin</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Breakdown Section -->
        <div class="job-breakdown-section">
          <div class="breakdown-container stacked">
            <div class="breakdown-card">
              <div class="chart-header">
                <div class="chart-header-title">
                  <h3>Contract Value by Project Manager</h3>
                </div>
                <div class="chart-header-controls">
                  <button class="page-chart-expand-btn" data-chart="pmDonutChart" data-title="Contract Value by Project Manager" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
                </div>
              </div>
              <div class="donut-flex-container">
                <div class="donut-canvas-wrapper">
                  <canvas id="pmDonutChart"></canvas>
                </div>
                <div class="donut-legend" id="pmDonutLegend"></div>
              </div>
              <button class="breakdown-expand-btn" data-target="pmTableWrapper">
                <span class="expand-text">Expand</span>
                <span class="expand-arrow">‚ñº</span>
              </button>
              <div class="breakdown-table-wrapper collapsed" id="pmTableWrapper">
                <table class="breakdown-table" id="jobPmBreakdownTable">
                  <thead>
                    <tr>
                      <th>Project Manager</th>
                      <th class="number-col">Jobs</th>
                      <th class="number-col">Contract</th>
                      <th class="number-col">Cost</th>
                      <th class="number-col">Profit</th>
                      <th class="number-col">Margin</th>
                    </tr>
                  </thead>
                  <tbody id="jobPmBreakdownBody">
                    <tr><td colspan="6" class="loading-cell">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="breakdown-card">
              <div class="chart-header">
                <div class="chart-header-title">
                  <h3>Contract Value by Client</h3>
                </div>
                <div class="chart-header-controls">
                  <button class="page-chart-expand-btn" data-chart="customerDonutChart" data-title="Contract Value by Client" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
                </div>
              </div>
              <div class="donut-flex-container">
                <div class="donut-canvas-wrapper">
                  <canvas id="customerDonutChart"></canvas>
                </div>
                <div class="donut-legend" id="customerDonutLegend"></div>
              </div>
              <button class="breakdown-expand-btn" data-target="customerTableWrapper">
                <span class="expand-text">Expand</span>
                <span class="expand-arrow">‚ñº</span>
              </button>
              <div class="breakdown-table-wrapper collapsed" id="customerTableWrapper">
                <table class="breakdown-table" id="jobCustomerBreakdownTable">
                  <thead>
                    <tr>
                      <th>Client</th>
                      <th class="number-col">Jobs</th>
                      <th class="number-col">Contract</th>
                      <th class="number-col">Cost</th>
                      <th class="number-col">Profit</th>
                      <th class="number-col">Margin</th>
                    </tr>
                  </thead>
                  <tbody id="jobCustomerBreakdownBody">
                    <tr><td colspan="6" class="loading-cell">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter Bar with Column Picker -->
        <div class="page-filter-bar">
          <div class="filter-group">
            <label for="jbJobNoSearch">Job #:</label>
            <input type="text" id="jbJobNoSearch" class="filter-input" placeholder="Search job..." style="width: 120px;">
          </div>
          <div class="filter-group">
            <label for="jbDescriptionSearch">Description:</label>
            <input type="text" id="jbDescriptionSearch" class="filter-input" placeholder="Search description..." style="width: 180px;">
          </div>
          <div class="filter-group">
            <label for="jbClientSearch">Client:</label>
            <input type="text" id="jbClientSearch" class="filter-input" placeholder="Search client..." style="width: 150px;">
          </div>
        </div>

        <!-- Quick Sort Buttons -->
        <div class="quick-sort-buttons">
          <span class="quick-sort-label">Quick Sort:</span>
          <button class="quick-sort-btn" data-sort="revised_contract" data-dir="desc">Highest Contract Value</button>
          <button class="quick-sort-btn" data-sort="profit_margin" data-dir="desc">Highest Profit Margin %</button>
          <button class="quick-sort-btn" data-sort="profit_margin" data-dir="asc">Lowest Profit Margin %</button>
        </div>

        <!-- Jobs Table -->
        <div class="job-table-container">
          <div class="loading-overlay hidden" id="jobBudgetsLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
          </div>
          <table class="job-budgets-table" id="jobBudgetsTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="job_no">
                  <span class="column-header-text">Job #</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="job_no" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="job_no" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="job_description">
                  <span class="column-header-text">Description</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="job_description" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="job_description" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="customer_name">
                  <span class="column-header-text">Client</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="customer_name" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="customer_name" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="job_status">
                  <span class="column-header-text">Status</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="job_status" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="job_status" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="project_manager_name">
                  <span class="column-header-text">Project Manager</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="project_manager_name" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="project_manager_name" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col contract-detail-col hidden" data-sort="original_contract">Original Contract</th>
                <th class="number-col contract-detail-col hidden" data-sort="tot_income_adj">Change Orders</th>
                <th class="number-col revised-contract-col expandable-col sortable-number" data-sort="revised_contract">
                  <span class="expand-icon" data-expand="contract">‚ñ∂</span>
                  <span class="column-header-text">Contract Value</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="revised_contract" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="revised_contract" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col cost-detail-col hidden" data-sort="original_cost">Original Cost</th>
                <th class="number-col cost-detail-col hidden" data-sort="tot_cost_adj">Cost Adjustments</th>
                <th class="number-col revised-cost-col expandable-col sortable-number" data-sort="revised_cost">
                  <span class="expand-icon" data-expand="cost">‚ñ∂</span>
                  <span class="column-header-text">Projected Cost</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="revised_cost" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="revised_cost" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="estimated_profit">
                  <span class="column-header-text">Estimated Profit</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="estimated_profit" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="estimated_profit" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="profit_margin">
                  <span class="column-header-text">Profit Margin</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="profit_margin" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="profit_margin" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="jobBudgetsTableBody">
              <tr><td colspan="12" class="loading-cell">Loading job data...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="job-pagination" id="jobPagination">
          <button id="jobPrevPage" class="pagination-btn" disabled>‚Üê Previous</button>
          <span id="jobPageInfo" class="page-info">Page 1 of 1</span>
          <button id="jobNextPage" class="pagination-btn" disabled>Next ‚Üí</button>
          <select id="jobPageSize" class="page-size-select">
            <option value="25" selected>25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
            <option value="250">250 per page</option>
          </select>
        </div>
      </section>

      <!-- ============================================================
           JOB ACTUALS
      ============================================================= -->
      <section id="jobActuals" class="dashboard-section">
        <h2>Job Actuals</h2>
        <div class="data-as-of">Data as of: <span id="jobActualsDataAsOf">-</span></div>

        <!-- PM Tabs Bar -->
        <div class="pm-tabs-bar" id="jaPmTabsBar">
          <span class="pm-tabs-bar-label">Project Manager</span>
          <div class="pm-tabs-container" id="jaPmTabs">
            <span class="pm-tabs-loading">Loading...</span>
          </div>
        </div>

        <!-- Status Filter Row -->
        <div class="status-filter-bar" id="jaStatusBar">
          <div class="status-filter-group">
            <span class="status-filter-label">Status:</span>
            <div class="status-checkboxes">
              <label class="status-checkbox-label">
                <input type="checkbox" id="jaStatusActive" value="A" checked>
                Active
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="jaStatusInactive" value="I">
                Inactive
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="jaStatusClosed" value="C">
                Closed
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="jaStatusOverhead" value="O">
                Overhead
              </label>
            </div>
          </div>
        </div>

        <!-- AI Analysis Panel -->
        <div id="jaAiAnalysisPanel" class="ai-analysis-panel">
          <div class="ai-analysis-header" id="jaAiAnalysisHeader">
            <div class="ai-analysis-header-left">
              <span class="ai-analysis-toggle-icon">‚ñº</span>
              <span class="ai-analysis-title">AI ANALYSIS</span>
              <button type="button" id="jaAiAnalyzeBtn" class="ai-run-btn">Run Analysis</button>
            </div>
          </div>
          <div id="jaAiAnalysisBody" class="ai-analysis-body">
            <div id="jaAiAnalysisContent" class="ai-analysis-content"></div>
          </div>
        </div>

        <!-- Key Metrics Dashboard -->
        <div class="job-key-metrics-section">
          <h3 class="section-title">Key Metrics</h3>
          <div class="job-metrics-grid five-col">
            <div class="job-metric-card primary">
              <div class="metric-icon">üìã</div>
              <div class="metric-content">
                <div class="metric-value" id="jaTotalCount">-</div>
                <div class="metric-label">Total Jobs</div>
              </div>
            </div>
            <div class="job-metric-card">
              <div class="metric-icon">üíµ</div>
              <div class="metric-content">
                <div class="metric-value" id="jaTotalBilledRevenue">-</div>
                <div class="metric-label">Billed Revenue</div>
              </div>
            </div>
            <div class="job-metric-card">
              <div class="metric-icon">üìà</div>
              <div class="metric-content">
                <div class="metric-value" id="jaTotalEarnedRevenue">-</div>
                <div class="metric-label">Earned Revenue</div>
              </div>
            </div>
            <div class="job-metric-card">
              <div class="metric-icon">üìä</div>
              <div class="metric-content">
                <div class="metric-value" id="jaTotalActualCost">-</div>
                <div class="metric-label">Actual Cost</div>
              </div>
            </div>
            <div class="job-metric-card" id="jaOverUnderCard">
              <div class="metric-icon">‚öñÔ∏è</div>
              <div class="metric-content">
                <div class="metric-value" id="jaTotalOverUnder">-</div>
                <div class="metric-label">Over/(Under) Bill</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter Bar with Column Picker -->
        <div class="page-filter-bar">
          <div class="filter-group">
            <label for="jaJobNoSearch">Job #:</label>
            <input type="text" id="jaJobNoSearch" class="filter-input" placeholder="Search job..." style="width: 120px;">
          </div>
          <div class="filter-group">
            <label for="jaDescriptionSearch">Description:</label>
            <input type="text" id="jaDescriptionSearch" class="filter-input" placeholder="Search description..." style="width: 180px;">
          </div>
          <div class="filter-group">
            <label for="jaClientSearch">Client:</label>
            <input type="text" id="jaClientSearch" class="filter-input" placeholder="Search client..." style="width: 150px;">
          </div>
        </div>

        <!-- Quick Sort Buttons -->
        <div class="quick-sort-buttons">
          <span class="quick-sort-label">Quick Sort:</span>
          <button class="quick-sort-btn ja-quick-sort" data-sort="actual_cost" data-dir="desc">Highest Actual Cost</button>
          <button class="quick-sort-btn ja-quick-sort" data-sort="earned_revenue" data-dir="desc">Highest Earned Revenue</button>
          <button class="quick-sort-btn ja-quick-sort" data-sort="percent_complete" data-dir="desc">Highest % Complete</button>
        </div>

        <!-- Jobs Table -->
        <div class="job-table-container">
          <div class="loading-overlay hidden" id="jobActualsLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
          </div>
          <table class="job-budgets-table" id="jobActualsTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="job_no">
                  <span class="column-header-text">Job #</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="job_no" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="job_no" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="job_description">
                  <span class="column-header-text">Description</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="job_description" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="job_description" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="customer_name">
                  <span class="column-header-text">Client</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="customer_name" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="customer_name" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="job_status">
                  <span class="column-header-text">Status</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="job_status" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="job_status" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="project_manager_name">
                  <span class="column-header-text">Project Manager</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="project_manager_name" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="project_manager_name" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="billed_revenue">
                  <span class="column-header-text">Billed Revenue</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="billed_revenue" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="billed_revenue" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="earned_revenue">
                  <span class="column-header-text">Earned Revenue</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="earned_revenue" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="earned_revenue" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="over_under_bill">
                  <span class="column-header-text">Over/(Under)</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="over_under_bill" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="over_under_bill" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="actual_cost">
                  <span class="column-header-text">Actual Cost</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="actual_cost" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="actual_cost" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="percent_complete">
                  <span class="column-header-text">% Complete</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn ja-sort-btn" data-sort="percent_complete" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn ja-sort-btn" data-sort="percent_complete" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="jobActualsTableBody">
              <tr><td colspan="10" class="loading-cell">Loading job actuals data...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="job-pagination" id="jaPagination">
          <button id="jaPrevPage" class="pagination-btn" disabled>‚Üê Previous</button>
          <span id="jaPageInfo" class="page-info">Page 1 of 1</span>
          <button id="jaNextPage" class="pagination-btn" disabled>Next ‚Üí</button>
          <select id="jaPageSize" class="page-size-select">
            <option value="25" selected>25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
            <option value="250">250 per page</option>
          </select>
        </div>
      </section>

      <!-- ============================================================
           OVER/(UNDER) BILLING
      ============================================================= -->
      <section id="overUnderBilling" class="dashboard-section">
        <h2>Over/(Under) Billing</h2>
        <div class="section-subtitle">Job Billing Status Analysis</div>
        <div class="data-as-of">Data as of: <span id="oubDataAsOf">-</span></div>

        <!-- PM Tabs Bar -->
        <div class="pm-tabs-bar" id="oubPmTabsBar">
          <span class="pm-tabs-bar-label">Project Manager</span>
          <div class="pm-tabs-container" id="oubPmTabs"></div>
        </div>

        <!-- Key Metrics Section -->
        <div class="oub-key-metrics-section">
          <h3 class="metrics-section-header">Key Metrics</h3>
          <div class="job-metrics-row oub-metrics-row">
            <div class="job-metrics-container oub-metrics-container">
              <div class="job-metric-card compact primary">
                <div class="metric-icon">üìã</div>
                <div class="metric-content">
                  <div class="metric-value" id="oubTotalJobs">0</div>
                  <div class="metric-label">Total Jobs</div>
                </div>
              </div>
              <div class="job-metric-card compact">
                <div class="metric-icon">üìÑ</div>
                <div class="metric-content">
                  <div class="metric-value" id="oubTotalContract">$0</div>
                  <div class="metric-label">Contract Value</div>
                </div>
              </div>
              <div class="job-metric-card compact">
                <div class="metric-icon">üíµ</div>
                <div class="metric-content">
                  <div class="metric-value" id="oubTotalBilled">$0</div>
                  <div class="metric-label">Billed Revenue</div>
                </div>
              </div>
              <div class="job-metric-card compact">
                <div class="metric-icon">üìà</div>
                <div class="metric-content">
                  <div class="metric-value" id="oubTotalEarned">$0</div>
                  <div class="metric-label">Earned Revenue</div>
                </div>
              </div>
              <div class="job-metric-card compact" id="oubOverUnderCard">
                <div class="metric-icon">‚öñÔ∏è</div>
                <div class="metric-content">
                  <div class="metric-value" id="oubTotalOverUnder">$0</div>
                  <div class="metric-label">Net Over/(Under)</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Over/Under Charts -->
        <div class="oub-charts-row">
          <div class="oub-chart-container">
            <div class="chart-header">
              <div class="chart-header-title">
                <h3>Top 10 Overbilled Jobs</h3>
              </div>
              <div class="chart-header-controls">
                <button class="page-chart-expand-btn" data-chart="oubOverbilledChart" data-title="Top 10 Overbilled Jobs" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
              </div>
            </div>
            <div class="oub-chart-wrapper">
              <canvas id="oubOverbilledChart"></canvas>
            </div>
          </div>
          <div class="oub-chart-container">
            <div class="chart-header">
              <div class="chart-header-title">
                <h3>Top 10 Underbilled Jobs</h3>
              </div>
              <div class="chart-header-controls">
                <button class="page-chart-expand-btn" data-chart="oubUnderbilledChart" data-title="Top 10 Underbilled Jobs" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
              </div>
            </div>
            <div class="oub-chart-wrapper">
              <canvas id="oubUnderbilledChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Filter Bar -->
        <div class="page-filter-bar">
          <div class="filter-group">
            <label for="oubJobSearch">Job #:</label>
            <input type="text" id="oubJobSearch" class="filter-input" placeholder="Search job..." style="width: 120px;">
          </div>
        </div>

        <!-- Table -->
        <div class="table-wrapper">
          <table id="oubTable" class="data-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="job_no">
                  <span class="column-header-text">Job #</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="job_no" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="job_no" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="job_description">
                  <span class="column-header-text">Description</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="job_description" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="job_description" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="contract_value">
                  <span class="column-header-text">Contract Value</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="contract_value" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="contract_value" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="est_cost">
                  <span class="column-header-text">Est. Cost</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="est_cost" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="est_cost" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="est_profit">
                  <span class="column-header-text">Est. Profit</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="est_profit" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="est_profit" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="actual_cost">
                  <span class="column-header-text">Actual Cost</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="actual_cost" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="actual_cost" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="pct_complete">
                  <span class="column-header-text">% Complete</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="pct_complete" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="pct_complete" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="billed_revenue">
                  <span class="column-header-text">Billed Revenue</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="billed_revenue" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="billed_revenue" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="earned_revenue">
                  <span class="column-header-text">Earned Revenue</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="earned_revenue" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="earned_revenue" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable-number" data-sort="over_under">
                  <span class="column-header-text">Over/(Under)</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn oub-sort-btn" data-sort="over_under" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn oub-sort-btn" data-sort="over_under" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="oubTableBody">
              <tr><td colspan="10" class="loading-cell">Loading data...</td></tr>
            </tbody>
            <tfoot id="oubTableFoot">
              <tr class="totals-row">
                <td colspan="2"><strong>Totals</strong></td>
                <td class="number-col" id="oubFootContract">-</td>
                <td class="number-col" id="oubFootEstCost">-</td>
                <td class="number-col" id="oubFootEstProfit">-</td>
                <td class="number-col" id="oubFootActualCost">-</td>
                <td class="number-col" id="oubFootPctComplete">-</td>
                <td class="number-col" id="oubFootBilled">-</td>
                <td class="number-col" id="oubFootEarned">-</td>
                <td class="number-col" id="oubFootOverUnder">-</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Pagination -->
        <div class="job-pagination" id="oubPagination">
          <button id="oubPrevPage" class="pagination-btn" disabled>‚Üê Previous</button>
          <span id="oubPageInfo" class="page-info">Page 1 of 1</span>
          <button id="oubNextPage" class="pagination-btn" disabled>Next ‚Üí</button>
          <select id="oubPageSize" class="page-size-select">
            <option value="25" selected>25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
            <option value="250">250 per page</option>
          </select>
        </div>
      </section>

      <!-- ============================================================
           COST CODE ANALYSIS
      ============================================================= -->
      <section id="costCodes" class="dashboard-section">
        <h2>Cost Code Analysis</h2>
        <div class="section-subtitle">Job Cost Breakdown by Category</div>
        <div class="data-as-of">Data as of: <span id="costCodesDataAsOf">-</span></div>

        <!-- PM Tabs Bar -->
        <div class="pm-tabs-bar" id="ccPmTabsBar">
          <span class="pm-tabs-bar-label">Project Manager</span>
          <div class="pm-tabs-container" id="ccPmTabs">
            <span class="pm-tabs-loading">Loading...</span>
          </div>
        </div>

        <!-- Status Filter Row -->
        <div class="status-filter-bar" id="ccStatusBar">
          <div class="status-filter-group">
            <span class="status-filter-label">Status:</span>
            <div class="status-checkboxes">
              <label class="status-checkbox-label">
                <input type="checkbox" id="ccStatusActive" value="A" checked>
                Active
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="ccStatusInactive" value="I">
                Inactive
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="ccStatusClosed" value="C">
                Closed
              </label>
              <label class="status-checkbox-label">
                <input type="checkbox" id="ccStatusOverhead" value="O">
                Overhead
              </label>
            </div>
          </div>
        </div>

        <!-- Charts Row - Top Spend Categories as a % of Revenue -->
        <div class="cc-charts-row">
          <div class="cc-chart-container full-width">
            <div class="chart-header">
              <div class="chart-header-title">
                <h3>Top Spend Categories as a % of Revenue</h3>
              </div>
              <div class="chart-header-controls">
                <button class="page-chart-expand-btn" data-chart="ccRevenueChart" data-title="Top Spend Categories as a % of Revenue" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
              </div>
            </div>
            <div class="cc-chart-wrapper" id="ccRevenueChartWrapper">
              <canvas id="ccRevenueChart"></canvas>
            </div>
            <div class="cc-chart-hint">Shows which cost categories consume the largest share of earned revenue</div>
          </div>
        </div>

        <!-- Filter Bar -->
        <div class="page-filter-bar">
          <div class="filter-group">
            <label for="ccClientSearchBar">Client:</label>
            <input type="text" id="ccClientSearchBar" class="filter-input" placeholder="Search client..." style="width: 150px;">
          </div>
          <div class="filter-group">
            <label for="ccJobSearchBar">Job #:</label>
            <input type="text" id="ccJobSearchBar" class="filter-input" placeholder="Search job..." style="width: 120px;">
          </div>
        </div>

        <!-- Cost Codes Table -->
        <div class="job-table-container">
          <div class="loading-overlay hidden" id="costCodesLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading cost code data...</div>
          </div>
          <table class="job-table" id="costCodesTable">
            <thead>
              <tr id="ccTableHeaderRow">
                <th class="sortable" data-sort="job_no">
                  <span class="column-header-text">Job #</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn cc-sort-btn" data-sort="job_no" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn cc-sort-btn" data-sort="job_no" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="job_description">
                  <span class="column-header-text">Job Description</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn cc-sort-btn" data-sort="job_description" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn cc-sort-btn" data-sort="job_description" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="project_manager">
                  <span class="column-header-text">Project Manager</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn cc-sort-btn" data-sort="project_manager" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn cc-sort-btn" data-sort="project_manager" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="cost_code">
                  <span class="column-header-text">Cost Code</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn cc-sort-btn" data-sort="cost_code" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn cc-sort-btn" data-sort="cost_code" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="description">
                  <span class="column-header-text">Description</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn cc-sort-btn" data-sort="description" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn cc-sort-btn" data-sort="description" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable number-col" data-sort="total_cost">
                  <span class="column-header-text">Total Cost</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn cc-sort-btn" data-sort="total_cost" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn cc-sort-btn" data-sort="total_cost" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable number-col" data-sort="pct_of_total">
                  <span class="column-header-text">% of Total Cost</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn cc-sort-btn" data-sort="pct_of_total" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn cc-sort-btn" data-sort="pct_of_total" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable number-col" data-sort="pct_of_revenue">
                  <span class="column-header-text">% of Revenue</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn cc-sort-btn" data-sort="pct_of_revenue" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn cc-sort-btn" data-sort="pct_of_revenue" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="costCodesTableBody">
              <tr><td colspan="8" class="loading-cell">Loading cost code data...</td></tr>
            </tbody>
            <tfoot id="costCodesTableFoot">
              <tr class="totals-row">
                <td colspan="5"><strong>Totals</strong></td>
                <td class="number-col" id="ccTotalCostCell">-</td>
                <td class="number-col" id="ccTotalPctCell">100.00%</td>
                <td class="number-col" id="ccTotalRevPctCell">-</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Pagination -->
        <div class="job-pagination" id="ccPagination">
          <button id="ccPrevPage" class="pagination-btn" disabled>‚Üê Previous</button>
          <span id="ccPageInfo" class="page-info">Page 1 of 1</span>
          <button id="ccNextPage" class="pagination-btn" disabled>Next ‚Üí</button>
          <select id="ccPageSize" class="page-size-select">
            <option value="25" selected>25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
            <option value="all">Show All</option>
          </select>
        </div>
      </section>

      <!-- ============================================================
           PAYMENTS
      ============================================================= -->
      <section id="payments" class="dashboard-section">
        <h2>Payments</h2>
        <div class="data-as-of">Data as of: <span id="paymentsDataAsOf">-</span></div>

        <!-- Top 10 Vendors Chart Section -->
        <div class="payments-chart-section">
          <h3 class="metrics-section-header">Top 10 Vendors by Spend</h3>
          <div class="payments-year-range">
            <label>Year Range:</label>
            <span id="payYearStartLabel" class="year-label">2015</span>
            <input type="range" id="payYearStart" min="2015" max="2025" value="2015" class="year-slider">
            <span class="range-separator">to</span>
            <input type="range" id="payYearEnd" min="2015" max="2025" value="2025" class="year-slider">
            <span id="payYearEndLabel" class="year-label">2025</span>
          </div>
          <div class="payments-chart-wrapper">
            <canvas id="topVendorsChart"></canvas>
          </div>
        </div>

        <!-- Filter Bar with Column Picker -->
        <div class="page-filter-bar">
          <div class="filter-group">
            <label for="payJobSearch">Job #:</label>
            <input type="text" id="payJobSearch" class="filter-input" placeholder="Search job..." style="width: 120px;">
          </div>
          <div class="filter-group">
            <label for="payVendorSearch">Vendor:</label>
            <input type="text" id="payVendorSearch" class="filter-input" placeholder="Search vendor..." style="width: 180px;">
          </div>
          <div class="filter-group">
            <label for="payInvoiceSearch">Invoice #:</label>
            <input type="text" id="payInvoiceSearch" class="filter-input" placeholder="Search invoice..." style="width: 120px;">
          </div>
          <div class="filter-group">
            <label for="payPmFilter">Project Manager:</label>
            <select id="payPmFilter" class="filter-input" style="width: 180px;">
              <option value="">All Project Managers</option>
            </select>
          </div>
          <div class="filter-spacer"></div>
          <div class="column-picker-container">
            <button class="column-picker-btn" id="paymentsColumnPickerBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
              </svg>
              <span>Columns</span>
            </button>
            <div class="column-picker-dropdown" id="paymentsColumnPickerDropdown">
              <div class="column-picker-header">
                <span class="column-picker-title">Show/Hide Columns</span>
                <button class="column-picker-close" id="paymentsColumnPickerClose">&times;</button>
              </div>
              <div class="column-picker-body" id="paymentsColumnPickerBody">
              </div>
              <div class="column-picker-footer">
                <button class="column-picker-reset" id="paymentsColumnPickerReset">Reset</button>
                <button class="column-picker-apply" id="paymentsColumnPickerApply">Apply</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Payments Table -->
        <div class="job-table-container">
          <div class="loading-overlay hidden" id="paymentsLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
          </div>
          <table class="job-budgets-table" id="paymentsTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="vendor">
                  <span class="column-header-text">Vendor</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="vendor" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="vendor" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="invoice_no">
                  <span class="column-header-text">Invoice #</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="invoice_no" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="invoice_no" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="invoice_date">
                  <span class="column-header-text">Invoice Date</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="invoice_date" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="invoice_date" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="job_no">
                  <span class="column-header-text">Job #</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="job_no" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="job_no" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="job_description">
                  <span class="column-header-text">Job Desc.</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="job_description" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="job_description" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="project_manager">
                  <span class="column-header-text">Project Manager</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="project_manager" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="project_manager" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col retention-col sortable" data-sort="non_retention">
                  <span class="column-header-text">Non-Retention</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="non_retention" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="non_retention" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col retention-col sortable" data-sort="retention">
                  <span class="column-header-text">Retention</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="retention" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="retention" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable" data-sort="invoice_amount">
                  <span class="column-header-text">Invoice Amount</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="invoice_amount" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="invoice_amount" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable" data-sort="paid_to_date">
                  <span class="column-header-text">Paid-to-Date</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="paid_to_date" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="paid_to_date" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="number-col sortable" data-sort="remaining_balance">
                  <span class="column-header-text">Remaining</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="remaining_balance" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="remaining_balance" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable" data-sort="status">
                  <span class="column-header-text">Status</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="status" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="status" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody">
              <tr><td colspan="12" class="loading-cell">Loading invoice data...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="job-pagination" id="paymentsPagination">
          <button id="paymentsPrevPage" class="pagination-btn" disabled>‚Üê Previous</button>
          <span id="paymentsPageInfo" class="page-info">Page 1 of 1</span>
          <button id="paymentsNextPage" class="pagination-btn" disabled>Next ‚Üí</button>
          <select id="paymentsPageSize" class="page-size-select">
            <option value="25" selected>25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
            <option value="250">250 per page</option>
          </select>
        </div>
      </section>

      <!-- ============================================================
           AP AGING REPORT
      ============================================================= -->
      <section id="apAging" class="dashboard-section">
        <h2>Accounts Payable Aging Report</h2>
        <div class="data-as-of">Data as of: <span id="apAgingDataAsOf">-</span></div>

        <!-- PM Selection Tabs -->
        <div class="pm-tabs-bar">
          <span class="pm-tabs-bar-label">Project Manager:</span>
          <div class="pm-tabs-container" id="apAgingPmTabs">
            <span class="pm-tabs-loading">Loading...</span>
          </div>
        </div>

        <!-- Summary Metrics -->
        <div class="ap-aging-summary">
          <div class="summary-card">
            <div class="summary-label">Total Due (excl. Retainage)</div>
            <div class="summary-value" id="apAgingTotalDue">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Current (0-30 Days)</div>
            <div class="summary-value aging-0-30" id="apAgingCurrent">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">31-60 Days</div>
            <div class="summary-value aging-31-60" id="apAging31to60">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">61-90 Days</div>
            <div class="summary-value aging-61-90" id="apAging61to90">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">90+ Days</div>
            <div class="summary-value negative" id="apAging90plus">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Total Retainage</div>
            <div class="summary-value aging-retainage" id="apAgingRetainage">$0.00</div>
          </div>
        </div>

        <!-- Aging Buckets Chart -->
        <div class="ap-aging-chart-section">
          <div class="chart-header">
            <div class="chart-header-title">
              <h3>AP Aging</h3>
              <div class="chart-header-subtitle">as of: <span id="apAgingChartDate">-</span></div>
            </div>
            <div class="chart-header-controls">
              <button class="page-chart-expand-btn" data-chart="apAgingChart" data-title="AP Aging" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
            </div>
          </div>
          <div class="ap-aging-chart-wrapper">
            <canvas id="apAgingChart"></canvas>
          </div>
        </div>

        <!-- Filter Bar -->
        <div class="page-filter-bar">
          <div class="filter-group">
            <label for="apAgingSearch">Vendor:</label>
            <input type="text" id="apAgingSearch" class="filter-input" placeholder="Search vendor..." style="width: 200px;">
          </div>
          <div class="filter-group">
            <label for="apAgingJobSearch">Job #:</label>
            <input type="text" id="apAgingJobSearch" class="filter-input" placeholder="Search job..." style="width: 120px;">
          </div>
        </div>

        <!-- Loading Overlay -->
        <div id="apAgingLoadingOverlay" class="loading-overlay hidden">
          <div class="loading-spinner"></div>
          <span>Loading AP aging data...</span>
        </div>

        <!-- AP Aging Table -->
        <div class="table-wrapper">
          <table class="job-budgets-table ap-aging-table" id="apAgingTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="vendor_name">
                  <span class="column-header-text">Vendor</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="vendor_name" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="vendor_name" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="total_due">
                  <span class="column-header-text">Total Due</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="total_due" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="total_due" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="current">
                  <span class="column-header-text">0-30 Days</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="current" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="current" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="days_31_60">
                  <span class="column-header-text">31-60 Days</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="days_31_60" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="days_31_60" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="days_61_90">
                  <span class="column-header-text">61-90 Days</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="days_61_90" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="days_61_90" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="days_90_plus">
                  <span class="column-header-text">90+ Days</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="days_90_plus" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="days_90_plus" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="retainage">
                  <span class="column-header-text">Retainage</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="retainage" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="retainage" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="apAgingTableBody">
              <tr><td colspan="7" class="loading-cell">Loading AP aging data...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Vendor Invoice Detail Modal -->
        <div id="apAgingVendorModal" class="modal-overlay hidden">
          <div class="modal-dialog modal-xl">
            <div class="modal-header">
              <h3 id="apAgingVendorModalTitle">Vendor Invoices</h3>
              <button class="modal-close" id="apAgingVendorModalClose">&times;</button>
            </div>
            <div class="modal-body">
              <div id="apAgingVendorModalLoading" class="modal-loading">
                <div class="loading-spinner"></div>
                <span>Loading invoices...</span>
              </div>
              <div id="apAgingVendorModalContent" class="hidden">
                <div class="vendor-invoice-summary" id="vendorInvoiceSummary"></div>
                <div class="table-wrapper">
                  <table class="job-budgets-table vendor-invoices-table">
                    <thead>
                      <tr>
                        <th>Invoice #</th>
                        <th>Invoice Date</th>
                        <th>Job #</th>
                        <th>Job Description</th>
                        <th>Project Manager</th>
                        <th class="text-right">Invoice Amount</th>
                        <th class="text-right">Amount Paid</th>
                        <th class="text-right">Amount Due</th>
                        <th class="text-right">Retainage</th>
                        <th class="text-right">Days Out</th>
                      </tr>
                    </thead>
                    <tbody id="vendorInvoicesTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ============================================================
           AR AGING REPORT
      ============================================================= -->
      <section id="arAging" class="dashboard-section">
        <h2>Accounts Receivable Aging Report</h2>
        <div class="data-as-of">Data as of: <span id="arAgingDataAsOf">-</span></div>

        <!-- PM Selection Tabs -->
        <div class="pm-tabs-bar">
          <span class="pm-tabs-bar-label">Project Manager:</span>
          <div class="pm-tabs-container" id="arAgingPmTabs">
            <span class="pm-tabs-loading">Loading...</span>
          </div>
        </div>

        <!-- Key Metrics Title and Summary -->
        <h3 class="section-title" style="margin-top: 16px; margin-bottom: 12px; font-size: 16px; font-weight: 600; color: var(--text-primary);">Key Metrics</h3>
        <div class="ap-aging-summary">
          <div class="summary-card">
            <div class="summary-label">Total Due (excl. Retainage)</div>
            <div class="summary-value" id="arAgingTotalDue">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Current (0-30 Days)</div>
            <div class="summary-value aging-0-30" id="arAgingCurrent">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">31-60 Days</div>
            <div class="summary-value aging-31-60" id="arAging31to60">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">61-90 Days</div>
            <div class="summary-value aging-61-90" id="arAging61to90">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">90+ Days</div>
            <div class="summary-value negative" id="arAging90plus">$0.00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Total Retainage</div>
            <div class="summary-value aging-retainage" id="arAgingRetainage">$0.00</div>
          </div>
        </div>

        <!-- Aging Buckets Chart -->
        <div class="ap-aging-chart-section">
          <div class="chart-header">
            <div class="chart-header-title">
              <h3>AR Aging</h3>
              <div class="chart-header-subtitle">as of: <span id="arAgingChartDate">-</span></div>
            </div>
            <div class="chart-header-controls">
              <button class="page-chart-expand-btn" data-chart="arAgingChart" data-title="AR Aging" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
            </div>
          </div>
          <div class="ap-aging-chart-wrapper">
            <canvas id="arAgingChart"></canvas>
          </div>
        </div>

        <!-- Search Filter for Table -->
        <div class="page-filter-bar">
          <div class="filter-group">
            <label for="arAgingSearch">Search:</label>
            <input type="text" id="arAgingSearch" class="filter-input" placeholder="Search customer..." style="width: 200px;">
          </div>
        </div>

        <!-- Loading Overlay -->
        <div id="arAgingLoadingOverlay" class="loading-overlay hidden">
          <div class="loading-spinner"></div>
          <span>Loading AR aging data...</span>
        </div>

        <!-- AR Aging Table -->
        <div class="table-wrapper">
          <table class="job-budgets-table ar-aging-table" id="arAgingTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="customer_name">
                  <span class="column-header-text">Customer</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="customer_name" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="customer_name" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="total_due">
                  <span class="column-header-text">Total Due</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="total_due" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="total_due" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="current">
                  <span class="column-header-text">0-30 Days</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="current" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="current" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="days_31_60">
                  <span class="column-header-text">31-60 Days</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="days_31_60" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="days_31_60" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="days_61_90">
                  <span class="column-header-text">61-90 Days</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="days_61_90" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="days_61_90" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="days_90_plus">
                  <span class="column-header-text">90+ Days</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="days_90_plus" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="days_90_plus" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
                <th class="sortable text-right" data-sort="retainage">
                  <span class="column-header-text">Retainage</span>
                  <div class="sort-controls inline-sort">
                    <button class="sort-btn sort-asc-btn" data-sort="retainage" data-dir="asc" title="Sort ascending">‚ñ≤</button>
                    <button class="sort-btn sort-desc-btn" data-sort="retainage" data-dir="desc" title="Sort descending">‚ñº</button>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="arAgingTableBody">
              <tr><td colspan="7" class="loading-cell">Loading AR aging data...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Customer Invoice Detail Modal -->
        <div id="arAgingCustomerModal" class="modal-overlay hidden">
          <div class="modal-dialog modal-xl">
            <div class="modal-header">
              <h3 id="arAgingCustomerModalTitle">Customer Invoices</h3>
              <button class="modal-close" id="arAgingCustomerModalClose">&times;</button>
            </div>
            <div class="modal-body">
              <div id="arAgingCustomerModalLoading" class="modal-loading">
                <div class="loading-spinner"></div>
                <span>Loading invoices...</span>
              </div>
              <div id="arAgingCustomerModalContent" class="hidden">
                <div class="vendor-invoice-summary" id="customerInvoiceSummary"></div>
                <div class="table-wrapper">
                  <table class="job-budgets-table vendor-invoices-table">
                    <thead>
                      <tr>
                        <th>Invoice #</th>
                        <th>Invoice Date</th>
                        <th>Job #</th>
                        <th>Job Description</th>
                        <th>Project Manager</th>
                        <th class="text-right">Invoice Amount</th>
                        <th class="text-right">Amount Paid</th>
                        <th class="text-right">Amount Due</th>
                        <th class="text-right">Retainage</th>
                        <th class="text-right">Days Out</th>
                      </tr>
                    </thead>
                    <tbody id="customerInvoicesTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ============================================================
           AI INSIGHTS - Comprehensive Business Analysis
      ============================================================= -->
      <section id="aiInsights" class="dashboard-section">
        <h2>AI Insights</h2>
        <div class="section-subtitle">Comprehensive Business Intelligence</div>
        
        <div class="ai-insights-container">
          <!-- Hero Card with Run Button -->
          <div class="ai-insights-hero">
            <h3>Full Business Analysis</h3>
            <p>Analyze all financial data, jobs, accounts receivable, accounts payable, project managers, clients, and vendors to generate comprehensive insights and recommendations.</p>
            <button type="button" id="aiInsightsRunBtn" class="ai-insights-run-btn">
              <span class="btn-icon">‚ú®</span>
              <span class="btn-text">Run Full Analysis</span>
            </button>
            <div id="aiInsightsProgress" class="ai-insights-progress hidden">
              <div class="progress-bar">
                <div class="progress-fill" id="aiInsightsProgressFill"></div>
              </div>
              <div class="progress-text" id="aiInsightsProgressText">Aggregating data...</div>
            </div>
          </div>

          <!-- Results Container - Single unified section -->
          <div id="aiInsightsResults" class="ai-insights-results hidden">
            <div class="ai-insights-section">
              <h4 class="ai-insights-section-title">
                <span class="section-icon">üéØ</span>
                Analysis & Insights
              </h4>
              <div id="aiInsightsContent" class="ai-insights-content"></div>
            </div>
          </div>

          <!-- Error State -->
          <div id="aiInsightsError" class="ai-insights-error hidden">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-message" id="aiInsightsErrorMsg">An error occurred during analysis.</div>
            <button type="button" id="aiInsightsRetryBtn" class="ai-insights-retry-btn">Try Again</button>
          </div>
        </div>
      </section>

      <!-- ============================================================
           CASH BALANCES
      ============================================================= -->
      <section id="cashReports" class="dashboard-section">
        <h2>Cash Balances</h2>
        <div class="data-as-of">Data as of: <span id="cashDataAsOf">-</span></div>

        <!-- Current Balances Summary Header -->
        <div id="cashCurrentHeader" class="cash-current-header">
          <div class="loading-spinner">Loading...</div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section cash-chart-section" style="width: 80%; max-width: 80%;">
          <div class="chart-header">
            <h3>Daily Cash Balances</h3>
            <div class="chart-header-controls">
              <button class="chart-expand-btn" data-chart="cashChart" data-title="Daily Cash Balances" title="Expand chart"><svg viewBox="0 0 16 16" width="10" height="10"><path fill="currentColor" d="M2 2h5V0H0v7h2V2zm12 0h-5V0h7v7h-2V2zM2 14h5v2H0V9h2v5zm12 0h-5v2h7V9h-2v5z"/></svg></button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="cashChart"></canvas>
          </div>
          <div class="cash-range-buttons" id="cashRangeButtons">
            <button class="cash-range-btn" data-range="7" data-mode="bank">7D</button>
            <button class="cash-range-btn" data-range="30" data-mode="bank">30D</button>
            <button class="cash-range-btn active" data-range="90" data-mode="bank">90D</button>
            <button class="cash-range-btn" data-range="custom" data-mode="bank">Custom</button>
            <span class="cash-range-divider"></span>
            <button class="cash-range-btn" data-range="ttm" data-mode="gl">TTM</button>
            <button class="cash-range-btn" data-range="5y" data-mode="gl">5Y</button>
            <button class="cash-range-btn" data-range="all" data-mode="gl">All</button>
          </div>
          <div id="cashCustomRangeInline" class="cash-custom-range-inline" style="display: none;">
            <input type="date" id="cashCustomStartInline">
            <span>to</span>
            <input type="date" id="cashCustomEndInline">
            <button class="cash-apply-btn" id="cashApplyCustomInline">Apply</button>
          </div>
          <div class="cash-summary-tiles" id="cashSummaryTiles">
            <div class="summary-tile">
              <div class="tile-label">Average</div>
              <div class="tile-value" id="cashAvgValue">-</div>
            </div>
            <div class="summary-tile">
              <div class="tile-label">Highest</div>
              <div class="tile-value" id="cashMaxValue">-</div>
              <div class="tile-subvalue" id="cashMaxDate">-</div>
            </div>
            <div class="summary-tile">
              <div class="tile-label">Lowest</div>
              <div class="tile-value" id="cashMinValue">-</div>
              <div class="tile-subvalue" id="cashMinDate">-</div>
            </div>
            <div class="summary-tile">
              <div class="tile-label">Growth</div>
              <div class="tile-value" id="cashGrowthValue">-</div>
            </div>
          </div>
        </div>

        <!-- Data Tables with Tabs -->
        <div class="cash-history-section">
          <div class="cash-tabs">
            <button class="cash-tab active" data-tab="balances">Daily Balances</button>
            <button class="cash-tab" data-tab="transactions">Transactions</button>
          </div>
          <div id="cashTabBalances" class="cash-tab-content active">
            <div class="table-export-header">
              <button class="btn-export-small" id="exportDailyBalancesBtn" title="Export to Excel">
                <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12.9,14.5L15.8,19H14L12,15.6L10,19H8.2L11.1,14.5L8.2,10H10L12,13.4L14,10H15.8L12.9,14.5Z"/></svg>
                Export Excel
              </button>
            </div>
            <div id="dailyBalanceTableContainer" class="daily-balance-table-container">
              <div class="loading-spinner">Calculating daily balances...</div>
            </div>
          </div>
          <div id="cashTabTransactions" class="cash-tab-content">
            <div class="transaction-filter-row">
              <label for="transactionFilterInput">Search:</label>
              <input type="text" id="transactionFilterInput" placeholder="Filter by description, account, or amount...">
              <button type="button" class="filter-clear-btn" id="transactionFilterClear">Clear</button>
              <button class="btn-export-small" id="exportTransactionsBtn" title="Export to Excel">
                <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12.9,14.5L15.8,19H14L12,15.6L10,19H8.2L11.1,14.5L8.2,10H10L12,13.4L14,10H15.8L12.9,14.5Z"/></svg>
                Export Excel
              </button>
            </div>
            <div id="transactionTableContainer" class="transaction-table-container">
              <div class="loading-spinner">Loading transactions...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- DISTRIBUTION REPORTS SECTIONS (Admin Only) -->
      <section id="deptHeadMeeting" class="dashboard-section">
        <h2>Dept Head Meeting</h2>
        <p class="section-description">Department head meeting report content will appear here.</p>
        <div class="placeholder-content">
          <div class="placeholder-icon">üìã</div>
          <p>This report is under development.</p>
        </div>
      </section>

      <section id="cashReport" class="dashboard-section dcr-executive-layout">
        <div class="page-header-row">
          <div>
            <h2>Cash Report</h2>
            <p class="section-description" id="dcrDescription">FTG Builders cash position and activity - trailing 10 weeks</p>
            <!-- Daily/Weekly Toggle - moved under header -->
            <div class="dcr-view-toggle" style="margin-top: 12px;">
              <button class="dcr-toggle-btn" data-view="daily">Daily</button>
              <button class="dcr-toggle-btn active" data-view="weekly">Weekly</button>
            </div>
          </div>
        </div>
        
        <!-- Executive Summary -->
        <div class="dcr-executive-summary" id="dcrExecutiveSummary">
          <div class="dcr-summary-content">
            <span class="dcr-summary-text" id="dcrSummaryText">Loading executive summary...</span>
          </div>
        </div>
        
        <!-- Cash Balance Chart -->
        <div class="dcr-chart-container">
          <div class="dcr-chart-header">
            <h3 id="dcrChartTitle">Weekly Cash Balance</h3>
            <span class="dcr-chart-subtitle" id="dcrChartSubtitle">FTG Builders Combined</span>
          </div>
          <div class="chart-wrapper dcr-chart-wrapper">
            <canvas id="dcrCashChart"></canvas>
          </div>
        </div>
        
        <!-- Key Metric Tiles -->
        <div class="dcr-metrics-row">
          <div class="dcr-metric-tile">
            <div class="dcr-metric-label">Current Balance</div>
            <div class="dcr-metric-value" id="dcrCurrentBalance">--</div>
            <div class="dcr-metric-delta" id="dcrBalanceDelta"></div>
            <div class="dcr-metric-sublabel">Morning balance</div>
          </div>
          <div class="dcr-metric-tile">
            <div class="dcr-metric-label" id="dcrDepositsLabel">Deposits</div>
            <div class="dcr-metric-value positive" id="dcrDeposits">--</div>
            <div class="dcr-metric-delta" id="dcrDepositsDelta"></div>
            <div class="dcr-metric-sublabel" id="dcrDepositsSublabel">Past 7 days (excl. transfers)</div>
          </div>
          <div class="dcr-metric-tile">
            <div class="dcr-metric-label" id="dcrWithdrawalsLabel">Withdrawals</div>
            <div class="dcr-metric-value negative" id="dcrWithdrawals">--</div>
            <div class="dcr-metric-delta" id="dcrWithdrawalsDelta"></div>
            <div class="dcr-metric-sublabel" id="dcrWithdrawalsSublabel">Past 7 days (excl. transfers)</div>
          </div>
          <div class="dcr-metric-tile">
            <div class="dcr-metric-label">Net Change</div>
            <div class="dcr-metric-value" id="dcrPercentChange">--</div>
            <div class="dcr-metric-delta" id="dcrNetDelta"></div>
            <div class="dcr-metric-sublabel" id="dcrChangeSublabel">vs. prior week balance</div>
          </div>
        </div>
        
        <!-- Cash Balance Safety Check -->
        <div class="dcr-safety-check-section">
          <div class="dcr-safety-header">
            <h3>Cash Balance Safety Check</h3>
          </div>
          <div class="dcr-safety-content">
            <div class="dcr-safety-calculation">
              <div class="dcr-safety-item">
                <span class="dcr-safety-label">Cash Balance</span>
                <span class="dcr-safety-value" id="dcrSafetyCash">--</span>
              </div>
              <div class="dcr-safety-operator">+</div>
              <div class="dcr-safety-item">
                <span class="dcr-safety-label">Receivables (AR)</span>
                <span class="dcr-safety-value positive" id="dcrSafetyAR">--</span>
              </div>
              <div class="dcr-safety-operator">‚àí</div>
              <div class="dcr-safety-item">
                <span class="dcr-safety-label">Payables (AP)</span>
                <span class="dcr-safety-value negative" id="dcrSafetyAP">--</span>
              </div>
              <div class="dcr-safety-operator">‚àí</div>
              <div class="dcr-safety-item">
                <span class="dcr-safety-label">Net Over/Under Bill</span>
                <span class="dcr-safety-value" id="dcrSafetyOUB">--</span>
              </div>
              <div class="dcr-safety-operator">‚àí</div>
              <div class="dcr-safety-item">
                <span class="dcr-safety-label">Operating Reserve (3-mo SG&A)</span>
                <span class="dcr-safety-value negative" id="dcrSafetyOpExp">--</span>
              </div>
              <div class="dcr-safety-equals">=</div>
              <div class="dcr-safety-result">
                <span class="dcr-safety-label">Safety Check</span>
                <span class="dcr-safety-total" id="dcrSafetyTotal">--</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Top Transactions Sections -->
        <div class="dcr-transactions-grid">
          <div class="dcr-table-section">
            <div class="dcr-table-header">
              <h3 id="dcrDepositsTitle">Top 5 Deposits</h3>
              <span class="dcr-table-subtitle" id="dcrDepositsSubtitle">Prior day (excl. transfers)</span>
            </div>
            <div class="dcr-table-container" id="dcrDepositsContainer">
              <div class="loading-spinner">Loading...</div>
            </div>
          </div>
          <div class="dcr-table-section">
            <div class="dcr-table-header">
              <h3 id="dcrWithdrawalsTitle">Top 5 Withdrawals</h3>
              <span class="dcr-table-subtitle" id="dcrWithdrawalsSubtitle">Prior day (excl. transfers)</span>
            </div>
            <div class="dcr-table-container" id="dcrWithdrawalsContainer">
              <div class="loading-spinner">Loading...</div>
            </div>
          </div>
        </div>
      </section>

      <section id="monthEndReporting" class="dashboard-section">
        <h2>Month End Reporting</h2>
        <p class="section-description">Month end reporting content will appear here.</p>
        <div class="placeholder-content">
          <div class="placeholder-icon">üìÖ</div>
          <p>This report is under development.</p>
        </div>
      </section>

      <!-- ADMIN SECTION -->
      <section id="admin" class="dashboard-section">
        <h2>User Administration</h2>
        <p class="admin-description">Manage users, roles, and permissions for the FTG Dashboard.</p>
        
        <div class="admin-tabs">
          <button class="admin-tab active" data-tab="users">Users</button>
          <button class="admin-tab" data-tab="roles">Roles</button>
          <button class="admin-tab" data-tab="audit">Audit Log</button>
        </div>
        
        <!-- Users Tab -->
        <div id="adminUsersTab" class="admin-tab-content active">
          <div class="admin-toolbar">
            <button id="addUserBtn" class="btn-primary">+ Add User</button>
            <input type="text" id="userSearchInput" placeholder="Search users..." class="admin-search">
          </div>
          <div id="usersTableContainer" class="admin-table-container">
            <table class="admin-table" id="usersTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Last Login</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr><td colspan="6" class="loading-cell">Loading users...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Roles Tab -->
        <div id="adminRolesTab" class="admin-tab-content">
          <div id="rolesContainer" class="roles-container">
            <div class="loading-spinner">Loading roles...</div>
          </div>
        </div>
        
        <!-- Audit Log Tab -->
        <div id="adminAuditTab" class="admin-tab-content">
          <div class="admin-toolbar">
            <select id="auditCategoryFilter" class="audit-filter-select">
              <option value="">All Categories</option>
              <option value="authentication">Authentication</option>
              <option value="security">Security</option>
              <option value="user_management">User Management</option>
              <option value="role_management">Role Management</option>
              <option value="data_access">Data Access</option>
            </select>
            <select id="auditSeverityFilter" class="audit-filter-select">
              <option value="">All Severities</option>
              <option value="info">Info</option>
              <option value="warning">Warning</option>
              <option value="critical">Critical</option>
            </select>
            <input type="text" id="auditSearchInput" placeholder="Search logs..." class="admin-search" style="width: 200px;">
            <button id="refreshAuditBtn" class="btn-secondary">Refresh</button>
          </div>
          <div id="auditLogContainer" class="admin-table-container">
            <table class="admin-table" id="auditLogTable">
              <thead>
                <tr>
                  <th>Date/Time</th>
                  <th>Category</th>
                  <th>Severity</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Details</th>
                  <th>IP Address</th>
                </tr>
              </thead>
              <tbody id="auditLogBody">
                <tr><td colspan="7" class="loading-cell">Loading audit log...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- User Edit Modal -->
  <div id="userModal" class="modal-overlay hidden">
    <div class="modal-content modal-wide">
      <div class="modal-header">
        <h3 id="userModalTitle">Add User</h3>
        <button class="modal-close" onclick="closeUserModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editUserId" value="">
        <div class="form-row">
          <label for="userDisplayName">Display Name:</label>
          <input type="text" id="userDisplayName" placeholder="John Smith" />
        </div>
        <div class="form-row">
          <label for="userEmail">Email:</label>
          <input type="email" id="userEmail" placeholder="user@ftgbuilders.com" />
        </div>
        <div class="form-row">
          <label for="userRole">Role:</label>
          <select id="userRole">
            <option value="">Select Role...</option>
          </select>
        </div>
        <div class="form-row">
          <label for="userPassword">Password:</label>
          <input type="password" id="userPassword" placeholder="Min 6 characters" />
          <small id="passwordHint" class="form-hint">Leave blank to keep existing password</small>
        </div>
        <div class="form-row">
          <label for="userActive">Status:</label>
          <label class="toggle-switch">
            <input type="checkbox" id="userActive" checked>
            <span class="toggle-slider"></span>
            <span class="toggle-label">Active</span>
          </label>
        </div>
        <div id="userModalError" class="form-error"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeUserModal()">Cancel</button>
        <button class="btn-primary" id="saveUserBtn" onclick="saveUser()">Save User</button>
      </div>
    </div>
  </div>

  <!-- Role Modal -->
  <div id="roleModal" class="modal-overlay hidden">
    <div class="modal-content modal-wide">
      <div class="modal-header">
        <h3 id="roleModalTitle">Add Role</h3>
        <button class="modal-close" onclick="closeRoleModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editRoleId" value="">
        <div class="form-row">
          <label for="roleName">Role Name:</label>
          <input type="text" id="roleName" placeholder="e.g., Accountant" />
        </div>
        <div class="form-row">
          <label for="roleDescription">Description:</label>
          <input type="text" id="roleDescription" placeholder="Brief description of this role" />
        </div>
        <div class="form-row">
          <label>Page Access:</label>
          <div id="rolePermissionsGrid" class="permissions-grid-modal">
          </div>
        </div>
        <div id="roleModalError" class="form-error"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeRoleModal()">Cancel</button>
        <button class="btn-primary" id="saveRoleBtn" onclick="saveRole()">Save Role</button>
      </div>
    </div>
  </div>

  <!-- Role Reassignment Modal -->
  <div id="roleReassignModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Reassign Users</h3>
        <button class="modal-close" onclick="closeReassignModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="reassignMessage" class="reassign-message"></p>
        <div id="reassignUsersList" class="reassign-users-list"></div>
        <input type="hidden" id="reassignRoleId" value="">
        <div class="form-row">
          <label for="reassignNewRole">Reassign users to:</label>
          <select id="reassignNewRole">
            <option value="">Select new role...</option>
          </select>
        </div>
        <div id="reassignModalError" class="form-error"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeReassignModal()">Cancel</button>
        <button class="btn-danger" id="confirmReassignBtn" onclick="confirmReassignAndDelete()">Reassign & Delete Role</button>
      </div>
    </div>
  </div>

  <!-- Chart Fullscreen Modal -->
  <div id="chartFullscreenModal" class="chart-fullscreen-modal hidden">
    <div class="chart-fullscreen-header">
      <h3 id="chartFullscreenTitle">Chart</h3>
      <button class="chart-fullscreen-close" onclick="closeChartFullscreen()">&times;</button>
    </div>
    <div class="chart-fullscreen-body">
      <canvas id="chartFullscreenCanvas"></canvas>
    </div>
    <div class="chart-fullscreen-stats" id="chartFullscreenStats"></div>
  </div>

  <!-- Email Modal -->
  <div id="emailModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Email Report</h3>
        <button class="modal-close" onclick="closeEmailModal()">&times;</button>
      </div>
      <div class="modal-body">
        <label for="emailTo">Send to:</label>
        <input type="email" id="emailTo" placeholder="recipient@example.com" />
        <label for="emailSubject">Subject:</label>
        <input type="text" id="emailSubject" value="FTG Dashboard Report" />
        <div id="emailStatus" class="email-status"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeEmailModal()">Cancel</button>
        <button class="btn-primary" id="sendEmailBtn" onclick="sendReportEmail()">Send Email</button>
      </div>
    </div>
  </div>

  <!-- Schedule Email Modal -->
  <div id="scheduleEmailModal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 id="scheduleModalTitle">Schedule Email Report</h3>
        <button class="modal-close" onclick="closeScheduleEmailModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="schedule-tabs">
          <button class="schedule-tab active" data-tab="create">Create Schedule</button>
          <button class="schedule-tab" data-tab="manage">Manage Schedules</button>
        </div>
        
        <!-- Create Schedule Tab -->
        <div id="createScheduleTab" class="schedule-tab-content">
          <div class="form-row">
            <label for="scheduleReportName">Report Name:</label>
            <input type="text" id="scheduleReportName" placeholder="e.g., Weekly Revenue Report" />
          </div>
          <div class="form-row">
            <label for="scheduleRecipients">Recipients (comma-separated):</label>
            <input type="text" id="scheduleRecipients" placeholder="email1@example.com, email2@example.com" />
          </div>
          <div class="form-row">
            <label for="scheduleFrequency">Frequency:</label>
            <select id="scheduleFrequency">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div class="form-row" id="scheduleDayOfWeekRow">
            <label for="scheduleDayOfWeek">Day of Week:</label>
            <select id="scheduleDayOfWeek">
              <option value="0">Sunday</option>
              <option value="1" selected>Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </div>
          <div class="form-row hidden" id="scheduleDayOfMonthRow">
            <label for="scheduleDayOfMonth">Day of Month:</label>
            <select id="scheduleDayOfMonth">
              <option value="1">1st</option>
              <option value="15">15th</option>
              <option value="28">28th (last safe day)</option>
            </select>
          </div>
          <div class="form-row">
            <label for="scheduleSendTime">Send Time:</label>
            <input type="time" id="scheduleSendTime" value="08:00" />
          </div>
          <div class="form-row">
            <label class="checkbox-label">
              <input type="checkbox" id="scheduleActive" checked />
              Active (schedule is enabled)
            </label>
          </div>
          <input type="hidden" id="scheduleEditId" value="" />
          <div id="scheduleStatus" class="email-status"></div>
        </div>
        
        <!-- Manage Schedules Tab -->
        <div id="manageSchedulesTab" class="schedule-tab-content hidden">
          <div id="scheduledReportsList" class="scheduled-reports-list">
            <p class="loading-message">Loading scheduled reports...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeScheduleEmailModal()">Cancel</button>
        <button class="btn-primary" id="saveScheduleBtn" onclick="saveScheduledReport()">Save Schedule</button>
      </div>
    </div>
  </div>

  <!-- JS LIBRARIES - defer for non-blocking load -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- MAIN SCRIPT -->
  <script defer src="dashboard.js?v=20251225ae"></script>
  
  <!-- PWA Service Worker Registration with Aggressive Cache Busting -->
  <script>
    const APP_VERSION = '20251225ae';
    
    // Force unregister old service workers and clear caches on every load
    (async function() {
      // Always unregister ALL existing service workers first
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (const reg of registrations) {
          // Unregister any worker that's not our new v6
          if (reg.active && !reg.active.scriptURL.includes('sw-v6.js')) {
            await reg.unregister();
            console.log('Unregistered old service worker');
          }
        }
      }
      
      // Clear all caches on version change
      const storedVersion = localStorage.getItem('ftg_app_version');
      if (storedVersion !== APP_VERSION) {
        console.log('Version changed - clearing all caches');
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map(name => caches.delete(name)));
        }
        localStorage.setItem('ftg_app_version', APP_VERSION);
        // Reload only if we had an old version (not first visit)
        if (storedVersion) {
          window.location.reload(true);
          return;
        }
      }
      localStorage.setItem('ftg_app_version', APP_VERSION);
    })();
    
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          // Register NEW service worker at NEW path - forces Safari to get fresh worker
          const registration = await navigator.serviceWorker.register('/sw-v6.js');
          console.log('SW registered:', registration.scope);
          
          // Check for updates every 5 minutes
          setInterval(() => {
            registration.update();
          }, 5 * 60 * 1000);
          
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateNotification();
              }
            });
          });
        } catch (error) {
          console.log('SW registration failed:', error);
        }
      });
    }
    
    function showUpdateNotification() {
      const banner = document.createElement('div');
      banner.className = 'update-banner';
      banner.innerHTML = `
        <span>New version available!</span>
        <button onclick="location.reload()">Refresh</button>
      `;
      document.body.appendChild(banner);
    }
    
    async function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        const permission = await Notification.requestPermission();
        return permission === 'granted';
      }
      return Notification.permission === 'granted';
    }
    
    function setBadge(count) {
      if ('setAppBadge' in navigator) {
        if (count > 0) {
          navigator.setAppBadge(count);
        } else {
          navigator.clearAppBadge();
        }
      }
    }
  </script>
</body>
</html>
